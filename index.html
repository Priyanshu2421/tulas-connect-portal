<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TULA'S CONNECT - ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Reinforcing centering and fixing spacing */
        #auth-wrapper {
            display: none;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('https://tulas.edu.in/_next/static/media/BannerImage2.0ea55ef8.webp');
            background-size: cover;
            background-position: center;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .auth-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 2.5rem !important;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link.active { background-color: #16a34a !important; color: white !important; }
    </style>
</head>
<body class="bg-gray-50 font-['Inter']">

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-full opacity-0 transition-all duration-500 z-[10000] px-6 py-3 rounded-lg shadow-2xl font-bold text-white uppercase text-xs tracking-widest"></div>

    <!-- Generic Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative animate-fadeIn">
             <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition text-2xl">&times;</button>
             <div id="modal-content" class="p-8"></div>
        </div>
    </div>

    <!-- AUTHENTICATION WRAPPER -->
    <div id="auth-wrapper">
        <!-- LOGIN SECTION -->
        <div id="login-box" class="auth-card">
            <div class="text-center mb-8">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" onerror="this.src='https://placehold.co/64x64/22c55e/ffffff?text=TL'" alt="Logo" class="mx-auto mb-4 h-16">
                <h1 class="text-gray-900 font-black text-2xl tracking-tight uppercase">Tula's Connect</h1>
                <p class="text-green-600 text-[11px] font-bold italic mt-1 uppercase tracking-tighter">"Connecting Communities, Empowering Futures"</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Access Level</label>
                    <select id="login-role" onchange="updateAuthUI()" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-semibold">
                        <option>Student</option>
                        <option>Faculty</option>
                        <option value="Department Login">Department Head (HOD)</option>
                        <option>Admin</option>
                    </select>
                </div>
                
                <div id="login-dept-wrapper" class="hidden space-y-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Department</label>
                        <select id="login-dept" onchange="updateAuthUI()" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-semibold"></select>
                    </div>
                    <div id="login-eng-branch-wrapper" class="hidden">
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Engineering Branch</label>
                        <select id="login-eng-branch" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-semibold"></select>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">User ID / ID Card No</label>
                    <input type="text" id="login-id" required placeholder="Enter ID" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-semibold">
                </div>
                
                <div class="relative">
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Security Password</label>
                    <input type="password" id="login-pass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-semibold">
                    <button type="button" onclick="togglePass('login-pass')" class="absolute right-3 top-8 text-gray-400 hover:text-green-600">üëÅÔ∏è</button>
                </div>

                <div class="space-y-2">
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Verification Code</label>
                    <div class="flex items-center space-x-3 bg-white p-2 rounded-lg border">
                        <canvas id="login-captcha-canvas" width="120" height="40" onclick="generateLoginCaptcha()" class="rounded border cursor-pointer"></canvas>
                        <button type="button" onclick="generateLoginCaptcha()" class="text-gray-400 hover:text-green-600 transition p-2">üîÑ</button>
                        <input type="text" id="login-captcha-input" placeholder="Code" required class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-center font-bold">
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-green-600 text-white rounded-xl font-black shadow-lg hover:bg-green-700 transition uppercase tracking-widest text-xs">SECURE LOGIN</button>
            </form>

            <div class="mt-8 text-center border-t pt-6">
                <p class="text-xs text-gray-500 font-bold">New student? <button onclick="toggleAuthScreen('signup')" class="text-green-700 font-black hover:underline uppercase">Create Account</button></p>
            </div>
        </div>

        <!-- SIGNUP SECTION -->
        <div id="signup-box" class="hidden auth-card max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-gray-900 tracking-tight uppercase">Registration</h2>
                <p class="text-green-600 text-[10px] font-bold italic mt-1 uppercase tracking-tighter">"Connecting Communities, Empowering Futures"</p>
            </div>
            <form id="signup-form" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">I am a...</label>
                    <select name="role" id="signup-role" required onchange="updateSignupUI()" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-semibold">
                        <option value="">Select Role</option>
                        <option value="Student">Student</option>
                        <option value="Faculty">Faculty</option>
                    </select>
                </div>

                <input type="text" name="name" placeholder="Full Legal Name" required class="w-full p-3 bg-gray-50 border rounded-xl font-semibold">
                <input type="email" name="email" placeholder="Institutional Email (@tulas.edu.in)" required class="w-full p-3 bg-gray-50 border rounded-xl font-semibold">
                <input type="tel" name="phone" placeholder="Phone Number" required class="w-full p-3 bg-gray-50 border rounded-xl font-semibold">

                <div id="student-fields" class="hidden">
                    <input type="text" name="userId" id="signup-userid" placeholder="University Roll No." class="w-full p-3 bg-gray-50 border rounded-xl mt-3 font-semibold">
                </div>

                <div id="signup-dept-wrapper" class="hidden mt-3">
                    <select name="department" id="signup-dept" required onchange="updateSignupUI()" class="w-full p-3 bg-gray-50 border rounded-xl font-semibold">
                        <option value="">Select Department</option>
                    </select>
                </div>

                <div id="signup-course-wrapper" class="hidden mt-3">
                    <select name="course" id="signup-course" class="w-full p-3 bg-gray-50 border rounded-xl font-semibold">
                        <option value="">Select Course</option>
                    </select>
                </div>

                <input type="password" name="pass" placeholder="Create Password" required class="w-full p-3 bg-gray-50 border rounded-xl mt-3 font-semibold">
                
                <div class="space-y-2 mt-3">
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Human Verification</label>
                    <div class="flex items-center space-x-3 bg-white p-2 rounded-lg border">
                        <canvas id="captcha-canvas" width="120" height="40" onclick="generateCaptcha()" class="rounded border cursor-pointer"></canvas>
                        <button type="button" onclick="generateCaptcha()" class="text-gray-400 hover:text-green-600 transition p-2">üîÑ</button>
                        <input type="text" id="captcha-input" placeholder="Code" required class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-center font-bold">
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-green-600 text-white rounded-xl font-black shadow-lg hover:bg-green-700 transition uppercase tracking-widest text-xs mt-4">REGISTER ACCOUNT</button>
            </form>
            <div class="mt-6 text-center">
                <button onclick="toggleAuthScreen('login')" class="text-green-700 font-black hover:underline uppercase text-xs">‚Üê Back to Login</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside id="sidebar" class="text-gray-100 w-72 fixed h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col bg-[#064e3b]">
            <div class="p-6 flex items-center space-x-3 border-b border-white/10">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" class="h-10 w-10 rounded-full bg-white p-1">
                <div>
                    <h1 class="font-black text-lg leading-tight uppercase tracking-tight">Tula's</h1>
                    <p class="text-[8px] text-green-400 font-bold uppercase tracking-widest leading-none mt-0.5">Connecting Communities</p>
                    <p id="nav-role-badge" class="text-[10px] text-white/40 uppercase tracking-widest font-black mt-1 tracking-tighter">Portal</p>
                </div>
            </div>
            <nav id="nav-links" class="flex-1 overflow-y-auto py-6 space-y-1"></nav>
            <div class="p-4 border-t border-white/10">
                <button onclick="logout()" class="w-full flex items-center space-x-3 px-4 py-3 text-red-300 hover:bg-red-500/20 rounded-xl transition">
                    <span>üö™</span><span class="font-black uppercase text-xs tracking-widest">Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <div class="flex-1 md:ml-72 flex flex-col min-h-screen bg-gray-50">
            <header class="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-20">
                <div class="flex items-center space-x-3">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" class="h-8">
                    <span class="font-black text-green-800 tracking-tighter uppercase text-sm">Tula's Connect</span>
                </div>
                <button onclick="toggleSidebar()" class="p-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">‚ò∞</button>
            </header>

            <main class="p-4 md:p-8 flex-1 overflow-y-auto">
                <div id="content-area" class="max-w-6xl mx-auto min-h-[85vh] p-6 md:p-10 bg-white rounded-3xl shadow-xl border border-gray-100">
                    <!-- Dynamic Content Loads Here -->
                </div>
            </main>
        </div>
    </div>

    <!-- AI Helper Button -->
    <button id="chatbot-open-btn" onclick="toggleChatbot()" class="fixed bottom-5 left-5 w-14 h-14 bg-green-600 rounded-full shadow-2xl hover:bg-green-700 transition transform hover:scale-110 z-40 flex items-center justify-center text-2xl shadow-green-900/20">
        ü§ñ
    </button>

    <!-- AI Modal -->
    <div id="chatbot-modal" class="hidden fixed bottom-5 left-5 w-full max-w-sm h-[60vh] bg-white rounded-2xl shadow-2xl flex flex-col z-50 overflow-hidden transform transition-all border border-gray-100">
        <div class="p-4 bg-green-800 text-white flex justify-between items-center">
            <h3 class="font-black uppercase text-xs tracking-widest">AI Portal Assistant</h3>
            <button onclick="toggleChatbot()" class="text-2xl hover:text-red-300">&times;</button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50"></div>
        <form id="chat-form" class="p-3 border-t bg-white">
            <div class="flex space-x-2">
                <input type="text" id="chat-input" placeholder="How can I help you today?" class="flex-1 p-3 border rounded-xl outline-none focus:ring-1 focus:ring-green-500 font-medium text-sm">
                <button type="submit" class="bg-green-600 text-white px-5 rounded-xl hover:bg-green-700 transition font-black uppercase text-[10px]">Send</button>
            </div>
        </form>
    </div>

<script>
// =========================================
// === CONFIGURATION & DATA ===
// =========================================
const API_BASE = ''; 
let currentUser = JSON.parse(sessionStorage.getItem('user')) || null;
let currentCaptcha = '';
let currentLoginCaptcha = ''; 
const REQUIRED_DOMAIN = '@tulas.edu.in'; 

const DEPT_DATA = {
    "Department of Engineering": {
        branches: ["Computer Science & Engineering", "Civil Engineering", "Mechanical Engineering", "Electronics & Communication Engineering", "Electrical & Electronics Engineering"],
        courses: ["B.Tech CSE", "B.Tech Civil", "B.Tech Mechanical", "B.Tech ECE", "B.Tech EEE", "M.Tech CSE", "M.Tech Civil", "M.Tech Thermal Engg"],
        years: ["1st Year", "2nd Year", "3rd Year", "4th Year"],
        sections: ["A", "B", "C"]
    },
    "Department of Computer Applications": { courses: ["BCA", "MCA"], years: ["1st Year", "2nd Year", "3rd Year"], sections: ["A", "B"] },
    "Graduate School of Business": { courses: ["BBA", "MBA", "B.Com (Hons)"], years: ["1st Year", "2nd Year"], sections: ["A"] },
    "Department of Agriculture": { courses: ["B.Sc Agriculture"], years: ["1st Year", "2nd Year", "3rd Year", "4th Year"], sections: ["A"] },
    "Department of Applied Sciences and Humanities": { courses: ["B.Sc Physics", "B.Sc Chemistry", "B.A. English"], years: ["1st Year", "2nd Year", "3rd Year"], sections: ["A"] },
    "Department of Journalism and Communications": { courses: ["BA (Hons) Journalism & Mass Comm", "MA JMC"], years: ["1st Year", "2nd Year"], sections: ["A"] },
    "Tula's Institute of Pharmacy": { courses: ["B.Pharm", "D.Pharm"], years: ["1st Year", "2nd Year", "3rd Year", "4th Year"], sections: ["A"] }
};

// =========================================
// === INITIALIZATION ===
// =========================================
document.addEventListener('DOMContentLoaded', () => {
    initAuthDropdowns();
    generateCaptcha(); 
    generateLoginCaptcha(); 

    const authWrapper = document.getElementById('auth-wrapper');
    const dashboard = document.getElementById('dashboard');

    if (currentUser) {
        authWrapper.style.display = 'none';
        dashboard.classList.remove('hidden');
        showDashboard();
    } else {
        authWrapper.style.display = 'flex'; 
        updateAuthUI();
    }

    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const captchaInput = document.getElementById('login-captcha-input');
        
        if (captchaInput.value.toUpperCase() !== currentLoginCaptcha) {
            showToast('Incorrect Captcha Code', true);
            generateLoginCaptcha();
            captchaInput.value = '';
            return;
        }
        
        const role = document.getElementById('login-role').value;
        let dept = null;
        if (role === 'Department Login') {
            dept = document.getElementById('login-dept').value;
            if (dept === 'Department of Engineering') dept = document.getElementById('login-eng-branch').value;
        }

        await handleAuth('/login', {
            userId: document.getElementById('login-id').value.trim(),
            password: document.getElementById('login-pass').value,
            role: role === 'Department Login' ? 'HOD' : role,
            department: dept,
        });
    };

    document.getElementById('signup-form').onsubmit = async (e) => {
        e.preventDefault();
        const captchaInput = document.getElementById('captcha-input');
        if (captchaInput.value.toUpperCase() !== currentCaptcha) {
            showToast('Captcha Verification Failed', true);
            generateCaptcha();
            return;
        }
        const formData = new FormData(e.target);
        const payload = Object.fromEntries(formData);
        if (!payload.email.toLowerCase().endsWith(REQUIRED_DOMAIN)) {
            showToast(`Use Institutional Email ${REQUIRED_DOMAIN}`, true);
            return;
        }
        await handleAuth('/signup', payload, true);
    };

    document.getElementById('chat-form').onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;
        addMessageToChat(input.value.trim(), true);
        input.value = '';
        setTimeout(() => addMessageToChat("I'm here to help with your Tula's Portal navigation. What else can I do for you?", false), 800);
    };
});

// =========================================
// === CORE LOGIC FUNCTIONS ===
// =========================================

async function handleAuth(endpoint, payload, isSignup = false) {
    try {
        const res = await fetch(API_BASE + endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if (data.success) {
            if (isSignup) {
                showToast('Registration Success: Pending Admin Approval');
                toggleAuthScreen('login');
            } else {
                currentUser = data.user;
                sessionStorage.setItem('user', JSON.stringify(currentUser));
                showDashboard();
            }
        } else {
            showToast(data.message || 'Verification Error', true);
            isSignup ? generateCaptcha() : generateLoginCaptcha();
        }
    } catch (err) {
        showToast('Connection Refused. Is server running?', true);
        isSignup ? generateCaptcha() : generateLoginCaptcha();
    }
}

function showDashboard() {
    document.getElementById('auth-wrapper').style.display = 'none';
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('nav-role-badge').textContent = currentUser.role.toUpperCase();
    renderNavigation();
}

function renderNavigation() {
    const nav = document.getElementById('nav-links');
    nav.innerHTML = '';
    const MENU = {
        'Student': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'timetable', label: 'Timetable', icon: 'üìÖ' },
            { id: 'attendance', label: 'Attendance', icon: 'üìä' },
            { id: 'assignments', label: 'Assignments', icon: 'üìÅ' },
            { id: 'marks', label: 'Exam Results', icon: 'üìù' },
            { id: 'leaves', label: 'Leave Apply', icon: 'üì®' }
        ],
        'Faculty': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'fac-attendance', label: 'Attendance', icon: '‚úÖ' },
            { id: 'fac-assignments', label: 'Assignments', icon: 'üìö' },
            { id: 'fac-leaves', label: 'Student Leaves', icon: 'üì´' }
        ],
        'HOD': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'admin-batches', label: 'Batches', icon: 'üë•' },
            { id: 'admin-signup-requests', label: 'Sign-up Req', icon: '‚úã' },
            { id: 'fac-leaves', label: 'Approve Leaves', icon: '‚úÖ' }
        ],
        'Admin': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'admin-users', label: 'Manage Users', icon: 'üë•' },
            { id: 'admin-announcements', label: 'Announcements', icon: 'üì¢' },
            { id: 'admin-signup-requests', label: 'Approvals', icon: '‚úã' },
            { id: 'admin-batches', label: 'Manage Batches', icon: 'üë•' }
        ]
    };
    (MENU[currentUser.role] || []).forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav-link w-full flex items-center space-x-3 px-6 py-4 transition-all duration-200 hover:bg-white/10 rounded-lg group';
        btn.innerHTML = `<span class="text-xl group-hover:scale-110 transition-transform">${item.icon}</span><span class="font-black text-[10px] uppercase tracking-widest">${item.label}</span>`;
        btn.onclick = () => loadContent(item.id, btn);
        nav.appendChild(btn);
    });
    if (nav.firstChild) nav.firstChild.click();
}

async function loadContent(pageId, activeBtn) {
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    if (activeBtn) activeBtn.classList.add('active');
    
    if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
    const container = document.getElementById('content-area');
    container.innerHTML = '<div class="flex items-center justify-center py-40"><div class="loader"></div></div>';

    try {
        switch (pageId) {
            case 'profile': await loadProfile(container); break;
            case 'timetable': await loadTimetable(container); break;
            case 'attendance': await loadAttendance(container); break;
            case 'marks': await loadMarks(container); break;
            case 'assignments': await loadAssignmentsStudent(container); break;
            case 'leaves': await loadLeavesCommon(container); break;
            case 'fac-attendance': await loadFacultyAttendance(container); break;
            case 'fac-assignments': await loadFacultyAssignments(container); break;
            case 'fac-leaves': await loadFacultyLeaves(container); break;
            case 'admin-users': await loadAdminUsers(container); break;
            case 'admin-announcements': await loadAdminAnnouncements(container); break;
            case 'admin-signup-requests': await showAdminSignupRequests(container); break;
            case 'admin-batches': await loadAdminBatches(container); break;
            default: container.innerHTML = `<p class="text-center text-gray-400 py-20 uppercase tracking-widest font-black">Under Construction</p>`;
        }
    } catch (err) {
        console.error(err);
        container.innerHTML = `<div class="p-10 text-center"><div class="bg-red-50 text-red-600 p-6 rounded-3xl border border-red-100 inline-block"><p class="font-black uppercase text-xs tracking-widest">‚ö†Ô∏è Data Retrieval Failed</p><p class="text-sm mt-2 font-medium">${err.message}</p></div></div>`;
    }
}

// =========================================
// === RECOVERY FUNCTIONS (DATA RETRIEVAL) ===
// =========================================

async function loadProfile(container) {
    const res = await fetch(`${API_BASE}/profile/${currentUser.id}`);
    const data = await res.json();
    if (!data.success) throw new Error("Database profile match failed");
    const p = data.profile;
    container.innerHTML = `
        <div class="flex flex-col md:flex-row gap-12 animate-fadeIn">
            <div class="w-full md:w-1/3 text-center p-10 border rounded-[2rem] bg-gray-50/50">
                <img src="${p.photoUrl ? API_BASE+p.photoUrl : 'https://placehold.co/150?text='+p.name[0]}" class="w-36 h-36 mx-auto rounded-full object-cover border-4 border-green-100 shadow-xl mb-6">
                <h2 class="text-3xl font-black text-gray-900">${p.name}</h2>
                <p class="text-green-600 font-black uppercase text-[10px] tracking-[0.2em] mt-2">${p.role}</p>
                <div class="mt-8 pt-8 border-t border-gray-200 font-mono text-gray-400 text-xs font-bold tracking-tighter">UID: ${p.id}</div>
            </div>
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-y-10 gap-x-12 p-2">
                ${detailItem('Official Email', p.email)}
                ${detailItem('Phone Contact', p.phone || 'Not Registered')}
                ${detailItem('Department', p.department)}
                ${p.course ? detailItem('Course / Group', p.course) : ''}
                ${detailItem('Identity Status', 'Verified Institutional Account')}
                ${detailItem('Address', p.address || 'Campus Resident')}
            </div>
        </div>`;
}

function detailItem(label, value) {
    return `<div><p class="text-[9px] text-gray-400 uppercase font-black tracking-[0.15em] mb-1.5">${label}</p><p class="font-bold text-gray-800 text-lg tracking-tight">${value}</p></div>`;
}

async function loadTimetable(container) {
    const res = await fetch(`${API_BASE}/timetable?course=${encodeURIComponent(currentUser.course || '')}`);
    const data = await res.json();
    const tt = data.timetable || {};
    container.innerHTML = `<h2 class="text-2xl font-black mb-10 text-green-900 uppercase tracking-tight">Academic Schedule</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        ${Object.entries(tt).map(([day, slots]) => `
            <div class="bg-white border rounded-3xl shadow-sm overflow-hidden border-gray-100">
                <div class="bg-[#064e3b] text-white p-4 font-black text-[10px] text-center uppercase tracking-widest">${day}</div>
                <div class="p-6 space-y-4">
                    ${slots.map(s => `<div class="p-4 bg-gray-50 rounded-2xl border border-gray-100"><p class="text-[9px] font-black text-green-600 uppercase tracking-widest mb-1">${s.time}</p><p class="font-black text-gray-800 tracking-tight">${s.subject}</p></div>`).join('') || '<p class="text-center text-gray-300 py-6 text-xs font-bold uppercase italic">Holiday / Break</p>'}
                </div>
            </div>`).join('')}
    </div>`;
}

async function loadAttendance(container) {
    const res = await fetch(`${API_BASE}/attendance/${currentUser.id}`);
    const data = await res.json();
    if (!data.success) throw new Error("Attendance sync failed");
    container.innerHTML = `<h2 class="text-2xl font-black mb-10 text-green-900 uppercase tracking-tight">Attendance Audit</h2>
    <div class="border rounded-[2rem] overflow-hidden shadow-sm">
        <table class="w-full text-left">
            <tr class="bg-gray-50/80 border-b"><th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-widest">Course Subject</th><th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-widest">Metric</th><th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-widest text-center">Score</th></tr>
            ${Object.entries(data.attendance || {}).map(([sub, stats]) => {
                const pct = (stats.present / stats.total * 100) || 0;
                return `<tr class="border-b transition-colors hover:bg-green-50/30"><td class="p-6 font-black text-gray-700 tracking-tight">${sub}</td><td class="p-6 font-mono font-bold text-gray-500">${stats.present} / ${stats.total} Sessions</td><td class="p-6 text-center"><span class="px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-tighter ${pct < 75 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">${pct.toFixed(1)}% Ratio</span></td></tr>`;
            }).join('') || '<tr><td colspan="3" class="p-24 text-center font-black text-gray-300 uppercase tracking-[0.2em]">Zero Records Found</td></tr>'}
        </table>
    </div>`;
}

async function loadMarks(container) {
    const res = await fetch(`${API_BASE}/marks/${currentUser.id}`);
    const data = await res.json();
    container.innerHTML = `<h2 class="text-2xl font-black mb-10 text-green-900 uppercase tracking-tight">Examination Board</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        ${(data.marks || []).map(m => `
            <div class="p-8 border rounded-[2rem] flex justify-between items-center shadow-sm hover:shadow-md transition-shadow">
                <div><p class="text-[9px] text-gray-400 uppercase font-black tracking-widest mb-1">${m.exam}</p><p class="text-xl font-black text-gray-900 tracking-tight">${m.subject}</p></div>
                <div class="text-3xl font-black text-green-700">${m.marks}<span class="text-gray-200 text-xl font-bold">/${m.total}</span></div>
            </div>`).join('') || '<p class="col-span-2 text-center py-32 text-gray-300 font-black uppercase tracking-[0.2em]">Awaiting Declarations</p>'}
    </div>`;
}

async function loadAssignmentsStudent(container) {
    const res = await fetch(`${API_BASE}/assignments?course=${encodeURIComponent(currentUser.course || '')}`);
    const data = await res.json();
    container.innerHTML = `<h2 class="text-2xl font-black mb-10 text-green-900 uppercase tracking-tight">Pending Tasks</h2>
    <div class="space-y-8">
        ${(data.assignments || []).map(a => `
            <div class="p-10 border rounded-[2.5rem] flex flex-col md:flex-row justify-between items-start md:items-center gap-8 bg-white hover:border-green-100 transition-colors">
                <div class="flex-1"><p class="text-[10px] text-blue-600 font-black uppercase tracking-[0.15em] mb-2">Deadline: ${new Date(a.dueDate).toLocaleDateString()}</p><h3 class="text-2xl font-black tracking-tight text-gray-900">${a.title}</h3><p class="text-gray-500 font-medium mt-2 text-sm">${a.description}</p></div>
                <button onclick="openSubmitModal(${a.id})" class="bg-[#064e3b] text-white px-8 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl shadow-green-900/20 hover:scale-105 transition-transform">Upload Response</button>
            </div>`).join('') || '<p class="text-center py-32 text-gray-300 font-black uppercase tracking-[0.2em]">Workflow Completed</p>'}
    </div>`;
}

// =========================================
// === UTILITIES ===
// =========================================

function generateCaptchaText(id) {
    const canvas = document.getElementById(id); if(!canvas) return '';
    const ctx = canvas.getContext('2d');
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let text = '';
    ctx.clearRect(0,0,120,40);
    ctx.font = 'bold 22px monospace';
    for(let i=0; i<5; i++) {
        const c = chars.charAt(Math.floor(Math.random()*chars.length));
        text += c;
        ctx.fillStyle = `rgb(${Math.random()*150},${Math.random()*150},${Math.random()*150})`;
        ctx.save(); ctx.translate(15+(i*20), 25+(Math.random()*5)); ctx.rotate((Math.random()-0.5)*0.3);
        ctx.fillText(c, 0, 0); ctx.restore();
    }
    return text;
}
function generateCaptcha() { currentCaptcha = generateCaptchaText('captcha-canvas'); }
function generateLoginCaptcha() { currentLoginCaptcha = generateCaptchaText('login-captcha-canvas'); }

function initAuthDropdowns() {
    const selects = [document.getElementById('login-dept'), document.getElementById('signup-dept')];
    const depts = Object.keys(DEPT_DATA);
    selects.forEach(s => {
        if(s) s.innerHTML = '<option value="">Select Department</option>' + depts.map(d => `<option value="${d}">${d}</option>`).join('');
    });
}

function updateAuthUI() {
    const role = document.getElementById('login-role').value;
    const isHOD = role === 'Department Login';
    document.getElementById('login-dept-wrapper').classList.toggle('hidden', !isHOD);
    const deptSelect = document.getElementById('login-dept');
    if(isHOD && deptSelect.value === 'Department of Engineering') {
        document.getElementById('login-eng-branch-wrapper').classList.remove('hidden');
        document.getElementById('login-eng-branch').innerHTML = DEPT_DATA['Department of Engineering'].branches.map(b => `<option>${b}</option>`).join('');
    } else {
        document.getElementById('login-eng-branch-wrapper').classList.add('hidden');
    }
}

function updateSignupUI() {
    const role = document.getElementById('signup-role').value;
    const dept = document.getElementById('signup-dept').value;
    document.getElementById('signup-dept-wrapper').classList.toggle('hidden', !role);
    document.getElementById('student-fields').classList.toggle('hidden', role !== 'Student');
    const courseWrapper = document.getElementById('signup-course-wrapper');
    const courseSelect = document.getElementById('signup-course');
    if (role === 'Student' && dept) {
        courseWrapper.classList.remove('hidden');
        courseSelect.innerHTML = (DEPT_DATA[dept]?.courses || []).map(c => `<option value="${c}">${c}</option>`).join('');
    } else {
        courseWrapper.classList.add('hidden');
    }
}

function toggleAuthScreen(s) { 
    document.getElementById('login-box').classList.toggle('hidden', s!=='login');
    document.getElementById('signup-box').classList.toggle('hidden', s!=='signup');
    s === 'login' ? generateLoginCaptcha() : generateCaptcha();
}

function showToast(m, e=false) {
    const t = document.getElementById('toast');
    t.textContent = m;
    t.className = `fixed bottom-5 right-5 transform translate-y-0 opacity-100 transition-all z-[10001] px-6 py-3 rounded-xl shadow-2xl font-black text-[10px] uppercase tracking-widest ${e?'bg-red-600':'bg-green-600'}`;
    setTimeout(() => t.classList.add('translate-y-full', 'opacity-0'), 3500);
}

function logout() { sessionStorage.clear(); location.reload(); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
function toggleChatbot() { document.getElementById('chatbot-modal').classList.toggle('hidden'); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function togglePass(id) { const i = document.getElementById(id); i.type = i.type === 'password' ? 'text' : 'password'; }
function addMessageToChat(text, isUser) {
    const history = document.getElementById('chat-history');
    const msg = document.createElement('div');
    msg.className = isUser ? 'flex justify-end' : 'flex justify-start';
    msg.innerHTML = `<div class="${isUser?'bg-[#064e3b] text-white rounded-br-none':'bg-white text-gray-800 rounded-bl-none'} p-4 rounded-3xl max-w-[85%] text-xs font-bold shadow-sm border border-gray-100 leading-relaxed animate-slideIn">${text}</div>`;
    history.appendChild(msg);
    history.scrollTop = history.scrollHeight;
}

// RESTORED ADMIN/FACULTY ACTION HELPERS
async function loadFacultyLeaves(container) {
    const res = await fetch(`${API_BASE}/leaves/pending/${encodeURIComponent(currentUser.department)}?currentUserId=${currentUser.id}`);
    const data = await res.json();
    container.innerHTML = `<h2 class="text-2xl font-black mb-10 text-green-900 uppercase">Approval Requests</h2><div class="space-y-8">${(data.leaves || []).map(l => `<div class="p-10 border rounded-[2.5rem] bg-white shadow-sm"><div class="flex justify-between items-start mb-6"><div><h4 class="font-black text-xl text-gray-900 tracking-tight">${l.userId}</h4><p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">${l.type} Application</p></div><span class="text-[10px] font-black text-green-700 bg-green-50 px-4 py-1.5 rounded-full uppercase">${new Date(l.fromDate).toLocaleDateString()} - ${new Date(l.toDate).toLocaleDateString()}</span></div><p class="text-gray-600 italic bg-gray-50/50 p-6 rounded-2xl mb-8 border border-gray-100 font-medium">"${l.reason}"</p><div class="flex justify-end space-x-4"><button onclick="updateLeaveStatus(${l.id}, 'Rejected')" class="px-8 py-3 border border-red-100 text-red-500 font-black text-[10px] uppercase tracking-widest rounded-2xl hover:bg-red-50 transition">Reject</button><button onclick="updateLeaveStatus(${l.id}, 'Approved')" class="px-8 py-3 bg-[#064e3b] text-white font-black text-[10px] uppercase tracking-widest rounded-2xl shadow-xl hover:bg-green-900 transition">Approve</button></div></div>`).join('') || '<p class="text-center py-32 text-gray-300 font-black uppercase tracking-widest">Inbox Empty</p>'}</div>`;
}

async function loadAdminUsers(container) {
    const res = await fetch(`${API_BASE}/users`);
    const data = await res.json();
    container.innerHTML = `<h2 class="text-2xl font-black mb-10 text-green-900 uppercase">User Directory</h2><div class="border rounded-[2.5rem] overflow-hidden shadow-sm"><table class="w-full text-left"><tr class="bg-gray-50 border-b"><th class="p-6 text-[10px] font-black uppercase text-gray-400">Identity</th><th class="p-6 text-[10px] font-black uppercase text-gray-400">Class</th><th class="p-6 text-[10px] font-black uppercase text-gray-400">Department</th><th class="p-6 text-[10px] font-black uppercase text-gray-400">Actions</th></tr>${(data.users || []).map(u => `<tr class="border-b transition-colors hover:bg-gray-50"><td class="p-6"><p class="font-black text-gray-900 tracking-tight">${u.name}</p><p class="text-[10px] font-mono font-bold text-gray-400 uppercase">${u.id}</p></td><td class="p-6"><span class="bg-blue-50 text-blue-600 text-[9px] font-black px-3 py-1 rounded-full uppercase">${u.role}</span></td><td class="p-6 text-[10px] font-black text-gray-500 uppercase">${u.department || 'GLOBAL'}</td><td class="p-6"><button onclick="deleteUser('${u.id}')" class="text-red-300 hover:text-red-600 transition-colors">üóëÔ∏è</button></td></tr>`).join('')}</table></div>`;
}

function showModal(html) { document.getElementById('modal-content').innerHTML = html; document.getElementById('modal').classList.remove('hidden'); }
async function updateLeaveStatus(id, status) { await fetch(`${API_BASE}/leaves/${id}/action`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status}) }); showToast(`Decision: ${status}`); loadContent('fac-leaves'); }
async function deleteUser(id) { if(!confirm('Archive this user?')) return; await fetch(`${API_BASE}/users/${id}`, { method: 'DELETE' }); showToast('User Archival Success'); loadContent('admin-users'); }

</script>
</body>
</html>