<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TULA'S CONNECT - ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link.active { background-color: #15803d; color: white; border-left: 4px solid #22c55e; }
        aside::-webkit-scrollbar { width: 5px; }
        aside::-webkit-scrollbar-thumb { background: #166534; border-radius: 5px; }
    </style>
</head>
<body>

    <!-- NOTIFICATION TOAST -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-full opacity-0 transition-all duration-500 z-50 px-6 py-3 rounded-lg shadow-2xl font-medium text-white"></div>

    <!-- MAIN MODAL -->
    <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative">
             <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition text-2xl">&times;</button>
             <div id="modal-content" class="p-6"></div>
        </div>
    </div>

    <!-- AUTHENTICATION WRAPPER -->
    <div id="auth-wrapper" class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://clgtak.com/wp-content/uploads/2023/12/Industry.jpg');">
        
        <!-- LOGIN FORM -->
        <div id="login-box" class="w-full max-w-md bg-white/95 backdrop-blur-md p-8 rounded-2xl shadow-2xl">
            <div class="text-center mb-8">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" alt="Logo" class="h-16 mx-auto mb-2">
                <h1 class="text-2xl font-bold text-gray-900">Welcome Back</h1>
                <p class="text-gray-500">Sign in to Tula's Connect</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Login As</label>
                    <select id="login-role" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none transition" onchange="updateAuthUI()">
                        <option>Student</option>
                        <option>Faculty</option>
                        <option value="HOD">Department Head (HOD)</option>
                        <option>Admin</option>
                    </select>
                </div>
                
                <div id="login-dept-wrapper" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select id="login-dept" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" onchange="updateAuthUI()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <!-- NEW: Engineering Branch Dropdown -->
                    <div id="login-eng-branch-wrapper" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Engineering Branch</label>
                        <select id="login-eng-branch" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                    <input type="text" id="login-id" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" placeholder="e.g. 2024001">
                </div>
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-pass" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <button type="button" onclick="togglePass('login-pass')" class="absolute top-9 right-4 text-gray-400 hover:text-gray-600">üëÅÔ∏è</button>
                </div>

                <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-all transform hover:scale-[1.02]">SECURE LOGIN</button>
            </form>
            <div class="mt-6 text-center text-sm text-gray-600">
                New here? <button onclick="toggleAuthScreen('signup')" class="text-green-600 font-semibold hover:underline">Create an Account</button>
            </div>
        </div>

        <!-- SIGNUP FORM -->
        <div id="signup-box" class="hidden w-full max-w-md bg-white/95 backdrop-blur-md p-8 rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">Create Account</h2>
            <form id="signup-form" class="space-y-4">
                <input type="text" name="userId" placeholder="User ID / Roll No." required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                <input type="text" name="name" placeholder="Full Legal Name" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                <input type="email" name="email" placeholder="Email Address" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                <input type="password" name="pass" placeholder="Create Password" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                
                <select name="role" id="signup-role" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl" required onchange="updateSignupUI()">
                    <option value="">Select Role</option>
                    <option value="Student">Student</option>
                    <option value="Faculty">Faculty</option>
                </select>

                <div id="signup-dept-wrapper" class="hidden">
                    <select name="department" id="signup-dept" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl" required onchange="updateSignupUI()">
                        <option value="">Select Department</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div id="signup-course-wrapper" class="hidden">
                    <select name="course" id="signup-course" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                        <option value="">Select Course</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-all">REGISTER</button>
            </form>
            <div class="mt-6 text-center text-sm">
                <button onclick="toggleAuthScreen('login')" class="text-green-600 font-semibold hover:underline">‚Üê Back to Login</button>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- SIDEBAR NAV -->
        <aside id="sidebar" class="bg-green-900 text-gray-100 w-72 fixed h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col">
            <div class="p-6 flex items-center space-x-3 border-b border-green-800">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" class="h-10 w-10 rounded-full bg-white p-1">
                <div>
                    <h1 class="font-bold text-lg leading-tight">TULA'S CONNECT</h1>
                    <p id="nav-role-badge" class="text-xs text-green-300">Portal</p>
                </div>
            </div>
            <nav id="nav-links" class="flex-1 overflow-y-auto p-4 space-y-2"></nav>
            <div class="p-4 border-t border-green-800">
                <button onclick="logout()" class="w-full flex items-center space-x-3 px-4 py-3 text-red-300 hover:bg-green-800 hover:text-red-200 rounded-xl transition">
                    <span>üö™</span><span>Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <div class="flex-1 md:ml-72 flex flex-col min-h-screen">
            <!-- MOBILE HEADER -->
            <header class="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-20">
                <div class="flex items-center space-x-3">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" class="h-8">
                    <span class="font-bold text-green-800">TULA'S</span>
                </div>
                <button onclick="toggleSidebar()" class="p-2 text-gray-600 bg-gray-100 rounded-lg">‚ò∞</button>
            </header>

            <main class="p-4 md:p-8 flex-1 overflow-y-auto">
                <div id="content-area" class="max-w-5xl mx-auto bg-white min-h-[85vh] rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8">
                    <!-- Dynamic Content Loads Here -->
                </div>
            </main>
        </div>
    </div>

<script>
const API_BASE = ''; 
let currentUser = JSON.parse(sessionStorage.getItem('user')) || null;

const DEPT_DATA = {
    "Department of Engineering": { 
        branches: ["CSE", "Civil", "ME", "ECE", "EEE"],
        courses: ["B.Tech CSE", "B.Tech Civil", "B.Tech ME", "B.Tech ECE", "M.Tech"]
    },
    "Department of Computer Applications": { courses: ["BCA", "MCA", "B.Sc IT"] },
    "Graduate School of Business": { courses: ["BBA", "MBA", "B.Com (Hons)"] },
    "Department of Agriculture": { courses: ["B.Sc Agriculture"] },
    "Department of Journalism": { courses: ["BA (JMC)", "MA (JMC)"] }
};

document.addEventListener('DOMContentLoaded', () => {
    initAuthDropdowns();
    if (currentUser) showDashboard(); else updateAuthUI();

    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        let role = document.getElementById('login-role').value;
        let dept = document.getElementById('login-dept').value;
        
        // If Engineering HOD, use branch as department
        if (role === 'HOD' && dept === 'Department of Engineering') {
            dept = document.getElementById('login-eng-branch').value;
        }

        await handleAuth('/login', {
            userId: document.getElementById('login-id').value.trim(),
            password: document.getElementById('login-pass').value,
            role: role,
            department: dept
        });
    };

    document.getElementById('signup-form').onsubmit = async (e) => {
        e.preventDefault();
        await handleAuth('/signup', Object.fromEntries(new FormData(e.target)), true);
    };
});

function initAuthDropdowns() {
    const depts = Object.keys(DEPT_DATA);
    const opts = '<option value="">Select Department</option>' + depts.map(d => `<option value="${d}">${d}</option>`).join('');
    document.getElementById('login-dept').innerHTML = opts;
    document.getElementById('signup-dept').innerHTML = opts;
}

function updateAuthUI() {
    const role = document.getElementById('login-role').value;
    const dept = document.getElementById('login-dept').value;
    const isHOD = role === 'HOD';
    const isEng = dept === 'Department of Engineering';

    document.getElementById('login-dept-wrapper').classList.toggle('hidden', !isHOD);
    document.getElementById('login-eng-branch-wrapper').classList.toggle('hidden', !(isHOD && isEng));

    if (isHOD && isEng) {
        const branches = DEPT_DATA["Department of Engineering"].branches;
        document.getElementById('login-eng-branch').innerHTML = '<option value="">Select Branch</option>' +
            branches.map(b => `<option value="${b}">${b}</option>`).join('');
    }
}

function updateSignupUI() {
    const role = document.getElementById('signup-role').value;
    const dept = document.getElementById('signup-dept').value;
    document.getElementById('signup-dept-wrapper').classList.toggle('hidden', !['Student', 'Faculty'].includes(role));
    
    if (role === 'Student' && dept && DEPT_DATA[dept]) {
        document.getElementById('signup-course').innerHTML = '<option value="">Select Course</option>' + 
            DEPT_DATA[dept].courses.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('signup-course-wrapper').classList.remove('hidden');
    } else {
        document.getElementById('signup-course-wrapper').classList.add('hidden');
    }
}

async function handleAuth(endpoint, payload, isSignup = false) {
    try {
        showToast(isSignup ? 'Registering...' : 'Logging in...');
        const res = await fetch(API_BASE + endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if (data.success) {
            if (isSignup) {
                showToast('Success! Please login.', false);
                toggleAuthScreen('login');
                document.getElementById('signup-form').reset();
            } else {
                currentUser = data.user;
                sessionStorage.setItem('user', JSON.stringify(currentUser));
                showDashboard();
            }
        } else {
            showToast(data.message || 'Action failed', true);
        }
    } catch (err) {
        showToast('Connection failed. Is server running?', true);
    }
}

function showDashboard() {
    document.getElementById('auth-wrapper').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('nav-role-badge').textContent = currentUser.role.toUpperCase();
    renderNavigation();
}

function renderNavigation() {
    const nav = document.getElementById('nav-links');
    nav.innerHTML = '';
    const MENU = {
        'Student': [
            { id: 'profile', label: 'Profile', icon: 'üë§' },
            { id: 'timetable', label: 'Timetable', icon: 'üìÖ' },
            { id: 'attendance', label: 'Attendance', icon: 'üìä' },
            { id: 'marks', label: 'Results', icon: 'üìù' },
            { id: 'assignments', label: 'Assignments', icon: 'üìÅ' },
            { id: 'leaves', label: 'Leaves', icon: 'üì®' },
            { id: 'placements', label: 'Placements', icon: 'üíº' }
        ],
        'Faculty': [
            { id: 'profile', label: 'Profile', icon: 'üë§' },
            { id: 'fac-attendance', label: 'Mark Attendance', icon: '‚úÖ' },
            { id: 'fac-assignments', label: 'Assignments', icon: 'üìö' },
            { id: 'placements', label: 'Placements', icon: 'üíº' }
        ],
        'HOD': [
            { id: 'profile', label: 'Profile', icon: 'üë§' },
            { id: 'fac-leaves', label: 'Approve Leaves', icon: '‚úÖ' },
            { id: 'placements', label: 'Placements', icon: 'üíº' }
        ],
        'Admin': [
            { id: 'profile', label: 'Profile', icon: 'üë§' },
            { id: 'placements', label: 'Manage Placements', icon: 'üåç' }
        ]
    };

    (MENU[currentUser.role] || []).forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav-link w-full flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-green-800 hover:text-white rounded-xl transition-all duration-200';
        btn.innerHTML = `<span class="text-xl">${item.icon}</span><span class="font-medium">${item.label}</span>`;
        btn.onclick = () => loadContent(item.id, btn);
        nav.appendChild(btn);
    });
    if (nav.firstChild) nav.firstChild.click();
}

async function loadContent(pageId, activeBtn) {
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active', 'bg-green-800', 'text-white'));
    if (activeBtn) activeBtn.classList.add('active', 'bg-green-800', 'text-white');
    if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
    
    const container = document.getElementById('content-area');
    container.innerHTML = '<div class="loader"></div>';

    try {
        switch (pageId) {
            case 'profile': await loadProfile(container); break;
            case 'timetable': await loadTimetable(container); break;
            case 'attendance': await loadAttendance(container); break;
            case 'marks': await loadMarks(container); break;
            case 'assignments': await loadAssignmentsStudent(container); break;
            case 'leaves': await loadLeavesCommon(container); break;
            case 'fac-attendance': loadFacultyAttendance(container); break;
            case 'fac-assignments': await loadFacultyAssignments(container); break;
            case 'fac-leaves': await loadFacultyLeaves(container); break;
            case 'placements': await loadPlacements(container); break;
        }
    } catch (err) {
        container.innerHTML = `<div class="text-red-600 p-4">Error loading content: ${err.message}</div>`;
    }
}

// --- LOADERS ---
async function loadProfile(c) {
    const res = await fetch(`${API_BASE}/profile/${currentUser.id}`);
    const data = await res.json();
    if (!data.success) throw new Error("Profile not found");
    const p = data.profile;
    c.innerHTML = `
        <div class="flex flex-col md:flex-row gap-8 bg-gray-50 p-8 rounded-2xl">
            <div class="text-center md:w-1/3">
                 <img src="${p.photoUrl||'https://placehold.co/150'}" class="w-32 h-32 mx-auto rounded-full border-4 border-green-500 shadow-lg mb-4">
                 <h2 class="text-2xl font-bold">${p.name}</h2>
                 <p class="text-green-700 font-medium">${p.role}</p>
                 <p class="text-gray-500">${p.id}</p>
            </div>
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-6">
                ${detail('Email', p.email)} ${detail('Phone', p.phone)}
                ${detail('Department', p.department)} ${p.course ? detail('Course', p.course) : ''}
            </div>
        </div>`;
}

async function loadTimetable(c) {
    const res = await fetch(`${API_BASE}/timetable?course=${encodeURIComponent(currentUser.course)}`);
    const data = await res.json();
    c.innerHTML = `<h2 class="text-2xl font-bold mb-6">Timetable (${currentUser.course})</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">${Object.entries(data.timetable||{}).map(([day, slots]) => `
            <div class="bg-white border rounded-xl overflow-hidden"><div class="bg-green-700 text-white p-3 font-bold">${day}</div>
            <div class="p-4 space-y-3">${slots.map(s => `<div class="flex bg-gray-50 p-2 rounded"><span class="text-green-700 font-bold w-24">${s.time}</span><div><div class="font-medium">${s.subject}</div><div class="text-xs text-gray-500">${s.faculty}</div></div></div>`).join('')}</div></div>
        `).join('') || 'No timetable found.'}</div>`;
}

async function loadAttendance(c) {
    const res = await fetch(`${API_BASE}/attendance/${currentUser.id}`);
    const data = await res.json();
    c.innerHTML = `<h2 class="text-2xl font-bold mb-6">My Attendance</h2>
        <table class="w-full text-left bg-white rounded-xl overflow-hidden shadow-sm"><thead class="bg-gray-100"><tr><th class="p-4">Subject</th><th class="p-4">Stats</th><th class="p-4">%</th></tr></thead>
        <tbody>${Object.entries(data.attendance||{}).map(([sub, stat]) => {
            const pct = (stat.present/stat.total*100)||0;
            return `<tr class="border-t"><td class="p-4 font-medium">${sub}</td><td class="p-4">${stat.present}/${stat.total}</td><td class="p-4"><span class="px-2 py-1 rounded ${pct<75?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}">${pct.toFixed(1)}%</span></td></tr>`;
        }).join('') || '<tr><td colspan="3" class="p-4 text-center">No records found</td></tr>'}</tbody></table>`;
}

async function loadMarks(c) {
    const res = await fetch(`${API_BASE}/marks/${currentUser.id}`);
    const data = await res.json();
    c.innerHTML = `<h2 class="text-2xl font-bold mb-6">Exam Results</h2><div class="grid gap-4 md:grid-cols-2">
        ${data.marks.map(m => `<div class="bg-white p-5 rounded-xl border flex justify-between"><div><h4 class="font-bold">${m.subject}</h4><p class="text-sm text-gray-500">${m.exam}</p></div><div class="text-right"><span class="text-2xl font-bold text-green-700">${m.marks}</span><span class="text-gray-400">/${m.total}</span></div></div>`).join('') || 'No marks found.'}</div>`;
}

async function loadAssignmentsStudent(c) {
    const res = await fetch(`${API_BASE}/assignments?course=${encodeURIComponent(currentUser.course)}`);
    const data = await res.json();
    c.innerHTML = `<h2 class="text-2xl font-bold mb-6">Assignments</h2><div class="space-y-4">
        ${data.assignments.map(a => {
            const done = (a.submissions||[]).some(s => s.studentId === currentUser.id);
            return `<div class="p-5 border rounded-xl bg-white"><div class="flex justify-between mb-2"><h3 class="font-bold text-lg">${a.title}</h3><span class="px-3 py-1 rounded-full text-xs ${done?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">${done?'Submitted':'Pending'}</span></div><p class="text-gray-600 mb-4">${a.description}</p>${!done?`<button onclick="openSubmitModal(${a.id})" class="bg-green-600 text-white px-4 py-2 rounded-lg">Submit</button>`:''}</div>`;
        }).join('') || 'No assignments.'}</div>`;
}

async function loadLeavesCommon(c) {
    const res = await fetch(`${API_BASE}/leaves/${currentUser.id}`);
    const data = await res.json();
    c.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">My Leaves</h2><button onclick="openLeaveModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg">+ Apply</button></div>
        <div class="space-y-3">${data.leaves.map(l => `<div class="p-4 border rounded-xl flex justify-between items-center"><div><div class="font-bold">${l.type}</div><div class="text-sm">${l.reason}</div></div><span class="px-3 py-1 rounded-full text-sm ${l.status==='Approved'?'bg-green-100 text-green-800':l.status==='Rejected'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}">${l.status}</span></div>`).join('')||'No leave history.'}</div>`;
}

function loadFacultyAttendance(c) {
    c.innerHTML = `<h2 class="text-2xl font-bold mb-6">Mark Attendance</h2><form onsubmit="submitAttendance(event)" class="bg-white p-6 border rounded-xl max-w-md space-y-4">
        <input id="att-sid" placeholder="Student ID" required class="w-full p-3 border rounded-xl">
        <input id="att-sub" placeholder="Subject" required class="w-full p-3 border rounded-xl">
        <select id="att-status" class="w-full p-3 border rounded-xl"><option>Present</option><option>Absent</option></select>
        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Submit</button></form>`;
}

async function loadFacultyAssignments(c) {
    const res = await fetch(`${API_BASE}/assignments?facultyId=${currentUser.id}`);
    const data = await res.json();
    c.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">My Assignments</h2><button onclick="openCreateAssignModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg">+ Create</button></div>
        <div class="grid gap-4">${data.assignments.map(a => `<div class="p-5 border rounded-xl"><h3 class="font-bold">${a.title}</h3><p class="text-sm text-gray-500">${a.course} | ${a.submissions.length} submissions</p></div>`).join('')||'None created.'}</div>`;
}

async function loadFacultyLeaves(c) {
    const res = await fetch(`${API_BASE}/leaves/pending/${encodeURIComponent(currentUser.department)}`);
    const data = await res.json();
    c.innerHTML = `<h2 class="text-2xl font-bold mb-6">Pending Leaves (${currentUser.department})</h2><div class="space-y-4">
        ${data.leaves.map(l => `<div class="p-5 border rounded-xl bg-white"><div class="flex justify-between mb-2"><h4 class="font-bold">${l.userId} - ${l.type}</h4><span class="text-sm text-gray-500">${new Date(l.appliedOn).toLocaleDateString()}</span></div><p class="bg-gray-50 p-3 rounded mb-4">${l.reason}</p><div class="flex justify-end gap-3"><button onclick="leaveAction(${l.id},'Rejected')" class="text-red-600 border border-red-200 px-4 py-2 rounded">Reject</button><button onclick="leaveAction(${l.id},'Approved')" class="bg-green-600 text-white px-4 py-2 rounded">Approve</button></div></div>`).join('') || 'No pending requests.'}</div>`;
}

async function loadPlacements(c) {
    let url = `${API_BASE}/placements`;
    if (currentUser.role !== 'Admin') url += `?department=${encodeURIComponent(currentUser.department)}`;
    const res = await fetch(url);
    const data = await res.json();
    c.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Placements</h2>${['Admin','HOD'].includes(currentUser.role)?'<button onclick="openPlacementModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg">+ Post</button>':''}</div>
        <div class="grid gap-4">${data.placements.map(p => `<div class="p-5 border-l-4 border-green-500 bg-white rounded-xl shadow-sm"><h3 class="font-bold text-lg">${p.companyName} - ${p.jobTitle}</h3><p class="text-green-700 text-sm mb-2">${p.course}</p><p class="text-gray-600">${p.jobDescription}</p></div>`).join('') || 'No active drives.'}</div>`;
}

// --- UTILS & ACTIONS ---
function detail(l, v) { return `<div><p class="text-xs text-gray-500 uppercase font-bold">${l}</p><p class="font-medium">${v||'-'}</p></div>`; }
function togglePass(id) { const i = document.getElementById(id); i.type = i.type==='password'?'text':'password'; }
function toggleAuthScreen(s) { document.getElementById('login-box').classList.toggle('hidden', s!=='login'); document.getElementById('signup-box').classList.toggle('hidden', s!=='signup'); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
function logout() { sessionStorage.clear(); window.location.reload(); }
function showModal(h) { document.getElementById('modal-content').innerHTML = h; document.getElementById('modal').classList.remove('hidden'); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function showToast(m, e=false) { const t = document.getElementById('toast'); t.textContent = m; t.className = `fixed bottom-5 right-5 z-50 px-6 py-3 rounded-lg shadow-xl text-white transition-all duration-300 ${e?'bg-red-600':'bg-green-600'}`; setTimeout(()=>t.classList.add('translate-y-full', 'opacity-0'), 3000); }

// MODALS
window.openLeaveModal = () => showModal(`<h3 class="text-xl font-bold mb-4">Apply Leave</h3><form onsubmit="submitLeave(event)" class="space-y-4"><select name="type" class="w-full p-2 border rounded"><option>Sick</option><option>Casual</option></select><textarea name="reason" placeholder="Reason" required class="w-full p-2 border rounded"></textarea><button class="w-full bg-green-600 text-white py-2 rounded">Submit</button></form>`);
window.openCreateAssignModal = () => showModal(`<h3 class="text-xl font-bold mb-4">New Assignment</h3><form onsubmit="submitAssign(event)" class="space-y-4"><input name="title" placeholder="Title" required class="w-full p-2 border rounded"><textarea name="description" placeholder="Description" class="w-full p-2 border rounded"></textarea><input name="course" placeholder="Course (e.g. BCA)" required class="w-full p-2 border rounded"><button class="w-full bg-green-600 text-white py-2 rounded">Create</button></form>`);
window.openSubmitModal = (id) => showModal(`<h3 class="text-xl font-bold mb-4">Submit Work</h3><form onsubmit="submitWork(event, ${id})" class="space-y-4"><input type="file" name="submissionFile" required class="w-full p-2 border rounded"><button class="w-full bg-blue-600 text-white py-2 rounded">Upload</button></form>`);
window.openPlacementModal = () => showModal(`<h3 class="text-xl font-bold mb-4">Post Drive</h3><form onsubmit="submitPlacement(event)" class="space-y-4"><input name="companyName" placeholder="Company" required class="w-full p-2 border rounded"><input name="jobTitle" placeholder="Job Title" required class="w-full p-2 border rounded"><textarea name="jobDescription" placeholder="Details" required class="w-full p-2 border rounded"></textarea><input name="department" placeholder="Department" required class="w-full p-2 border rounded"><input name="course" placeholder="Course" required class="w-full p-2 border rounded"><button class="w-full bg-green-600 text-white py-2 rounded">Post</button></form>`);

// SUBMITS
async function submitLeave(e) { e.preventDefault(); await post('/leaves', {...Object.fromEntries(new FormData(e.target)), userId: currentUser.id, department: currentUser.department}); closeModal(); loadContent('leaves'); }
async function submitAttendance(e) { e.preventDefault(); await post('/attendance/mark', { studentId: document.getElementById('att-sid').value, subject: document.getElementById('att-sub').value, status: document.getElementById('att-status').value }); e.target.reset(); showToast('Marked!'); }
async function submitAssign(e) { e.preventDefault(); await post('/assignments', {...Object.fromEntries(new FormData(e.target)), facultyId: currentUser.id}); closeModal(); loadContent('fac-assignments'); }
async function submitWork(e, id) { e.preventDefault(); const fd = new FormData(e.target); fd.append('studentId', currentUser.id); await fetch(`${API_BASE}/assignments/${id}/submit`, {method:'POST', body:fd}); closeModal(); loadContent('assignments'); showToast('Submitted!'); }
async function leaveAction(id, status) { await post(`/leaves/${id}/action`, {status}); loadContent('fac-leaves'); }
async function submitPlacement(e) { e.preventDefault(); await post('/placements', Object.fromEntries(new FormData(e.target))); closeModal(); loadContent('placements'); }
async function post(url, data) { await fetch(API_BASE+url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); }
</script>
</body>
</html>