<div id="auth-wrapper" class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://clgtak.com/wp-content/uploads/2023/12/Industry.jpg');">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="login-box" class="w-full max-w-sm bg-white/95 backdrop-blur-md p-6 rounded-2xl shadow-2xl transform">
Â  Â  Â  Â  Â  Â  <div class="text-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" onerror="this.src='https://placehold.co/64x64/22c55e/ffffff?text=TL'" alt="Logo" class="h-14 mx-auto mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-xl font-bold text-gray-900">Welcome Back</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 text-sm">Sign in to Tula's Connect</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form id="login-form" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700 mb-0.5">Login As</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="login-role" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition" onchange="updateAuthUI()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option>Student</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option>Faculty</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Department Login">Department Head (HOD)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option>Admin</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="login-dept-wrapper" class="hidden space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700 mb-0.5">Department</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="login-dept" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none" onchange="updateAuthUI()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="login-eng-branch-wrapper" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700 mb-0.5">Engineering Branch</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="login-eng-branch" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700 mb-0.5">User ID</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="login-id" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="e.g. 2024001 or email">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="otp-verification-wrapper" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700 mb-0.5">Password</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="login-pass" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePass('login-pass')" class="absolute top-7 right-3 text-gray-400 hover:text-gray-600 transition text-lg">ğŸ‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700">Verify you are human</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="login-captcha-canvas" width="120" height="40" onclick="generateLoginCaptcha()"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="generateLoginCaptcha()" class="text-gray-500 hover:text-gray-700 transition" title="Refresh Captcha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”„
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="login-captcha-input" placeholder="Enter Captcha" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="secure-login-btn" class="w-full py-2.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all transform hover:scale-[1.01] shadow-lg text-sm">SECURE LOGIN</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <div class="mt-4 text-center text-xs text-gray-600">
Â  Â  Â  Â  Â  Â  Â  Â  New here? <button onclick="toggleAuthScreen('signup')" class="text-green-600 font-semibold hover:underline transition">Create an Account</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="signup-box" class="hidden w-full max-w-sm bg-white/95 backdrop-blur-md p-6 rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto transform">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-center text-gray-900 mb-4">Create Account</h2>
Â  Â  Â  Â  Â  Â  <form id="signup-form" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700 mb-0.5">I am a...</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select name="role" id="signup-role" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition" required onchange="updateSignupUI()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select Role</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Student">Student</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Faculty">Faculty</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" name="name" placeholder="Full Legal Name" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" name="email" placeholder="Email Address (@tulas.edu.in)" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" name="phone" placeholder="Phone Number" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">

Â  Â  Â  Â  Â  Â  Â  Â  <div id="student-fields" class="hidden space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" name="userId" id="signup-userid" placeholder="University Roll No." class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="signup-dept-wrapper" class="hidden space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select name="department" id="signup-dept" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition" required onchange="updateSignupUI()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select Department</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="signup-course-wrapper" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select name="course" id="signup-course" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select Course</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" name="pass" placeholder="Create Password" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-700">Verify you are human</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="captcha-canvas" width="120" height="40" onclick="generateCaptcha()"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="generateCaptcha()" class="text-gray-500 hover:text-gray-700 transition" title="Refresh Captcha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”„
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="captcha-input" placeholder="Enter Captcha" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none transition">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full py-2.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all shadow-lg text-sm">REGISTER</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <div class="mt-4 text-center text-xs">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="toggleAuthScreen('login')" class="text-green-600 font-semibold hover:underline transition">â† Back to Login</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
Â  Â  Â  Â  <aside id="sidebar" class="bg-green-900 text-gray-100 w-72 fixed h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col">
Â  Â  Â  Â  Â  Â  <div class="p-6 flex items-center space-x-3 border-b border-green-800">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" onerror="this.src='https://placehold.co/40x40/22c55e/ffffff?text=TL'" class="h-10 w-10 rounded-full bg-white p-1">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="font-bold text-lg leading-tight">TULA'S CONNECT</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="nav-role-badge" class="text-xs text-green-300">Portal</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <nav id="nav-links" class="flex-1 overflow-y-auto p-4 space-y-2"></nav>
Â  Â  Â  Â  Â  Â  <div class="p-4 border-t border-green-800">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="logout()" class="w-full flex items-center space-x-3 px-4 py-3 text-red-300 hover:bg-green-800 hover:text-red-200 rounded-xl transition transform hover:scale-[1.01]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸšª</span><span>Sign Out</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </aside>

Â  Â  Â  Â  <div class="flex-1 md:ml-72 flex flex-col min-h-screen">
Â  Â  Â  Â  Â  Â  <header class="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-20">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" onerror="this.src='https://placehold.co/32x32/22c55e/ffffff?text=TL'" class="h-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-green-800">TULA'S</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="toggleSidebar()" class="p-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">â˜°</button>
Â  Â  Â  Â  Â  Â  </header>

Â  Â  Â  Â  Â  Â  <main class="p-4 md:p-8 flex-1 overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="content-area" class="max-w-5xl mx-auto bg-white min-h-[85vh] rounded-2xl shadow-xl border border-gray-100 p-6 md:p-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <button id="chatbot-open-btn" onclick="toggleChatbot()" class="fixed bottom-5 left-5 w-14 h-14 bg-green-600 rounded-full shadow-xl hover:bg-green-700 transition transform hover:scale-110 z-40 flex items-center justify-center text-3xl">
Â  Â  Â  Â  ğŸ¤–
Â  Â  </button>

Â  Â  <div id="chatbot-modal" class="hidden fixed bottom-5 left-5 w-full max-w-sm h-[80vh] md:h-[600px] bg-white rounded-2xl shadow-2xl flex flex-col z-50 overflow-hidden transform transition-all duration-300">
Â  Â  Â  Â  <div class="p-4 bg-green-700 text-white flex justify-between items-center shadow-md">
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg">Tula's AI Helper</h3>
Â  Â  Â  Â  Â  Â  <button onclick="toggleChatbot()" class="text-white hover:text-green-200 transition">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-2xl">&times;</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
Â  Â  Â  Â  Â  Â  <div class="flex justify-start">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-200 text-gray-800 p-3 rounded-xl rounded-bl-none max-w-[80%] chat-bubble">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Hello! I'm your Tula's AI Portal Assistant. I can help you with general queries or provide up-to-date information using Google Search. Try asking me about new admissions or institute news!
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="chat-loading-indicator" class="hidden flex justify-start">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-xl bg-gray-200 chat-bubble">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loader-small"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <form id="chat-form" class="p-4 border-t border-gray-200 bg-white">
Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="chat-input" placeholder="Ask me anything..." required class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 outline-none">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="chat-submit-btn" class="bg-green-600 text-white px-4 py-3 rounded-xl hover:bg-green-700 transition disabled:bg-green-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Send
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>
Â  Â  </div>

<script>
// === CONFIGURATION & DATA ===
const API_BASE = '';Â 
let currentUser = JSON.parse(sessionStorage.getItem('user')) || null;
let currentCaptcha = '';
let currentLoginCaptcha = '';Â 
const REQUIRED_DOMAIN = '@tulas.edu.in';Â 

// Course Data Mapping (UPDATED with Year/Section placeholders)
const DEPT_DATA = {
Â  Â  "Department of Engineering": {
Â  Â  Â  Â  branches: [
Â  Â  Â  Â  Â  Â  "Computer Science & Engineering", "Civil Engineering", "Mechanical Engineering",
Â  Â  Â  Â  Â  Â  "Electronics & Communication Engineering", "Electrical & Electronics Engineering"
Â  Â  Â  Â  ],
Â  Â  Â  Â  courses: ["B.Tech CSE", "B.Tech Civil", "B.Tech Mechanical", "B.Tech ECE", "B.Tech EEE",
Â  Â  Â  Â  Â  Â  Â  Â  Â  "M.Tech CSE", "M.Tech Civil", "M.Tech Thermal Engg"],
Â  Â  Â  Â  years: ["1st Year", "2nd Year", "3rd Year", "4th Year"],
Â  Â  Â  Â  sections: ["A", "B", "C"]
Â  Â  },
Â  Â  "Department of Computer Applications": {Â 
Â  Â  Â  Â  courses: ["BCA", "MCA"],Â 
Â  Â  Â  Â  years: ["1st Year", "2nd Year", "3rd Year"],Â 
Â  Â  Â  Â  sections: ["A", "B"]Â 
Â  Â  },
Â  Â  "Graduate School of Business": {Â 
Â  Â  Â  Â  courses: ["BBA", "MBA", "B.Com (Hons)"],Â 
Â  Â  Â  Â  years: ["1st Year", "2nd Year"],Â 
Â  Â  Â  Â  sections: ["A"]Â 
Â  Â  },
Â  Â  "Department of Agriculture": {Â 
Â  Â  Â  Â  courses: ["B.Sc Agriculture"],Â 
Â  Â  Â  Â  years: ["1st Year", "2nd Year", "3rd Year", "4th Year"],Â 
Â  Â  Â  Â  sections: ["A"]Â 
Â  Â  },
Â  Â  "Department of Applied Sciences and Humanities": {Â 
Â  Â  Â  Â  courses: ["B.Sc Physics", "B.Sc Chemistry", "B.A. English"],Â 
Â  Â  Â  Â  years: ["1st Year", "2nd Year", "3rd Year"],Â 
Â  Â  Â  Â  sections: ["A"]Â 
Â  Â  },
Â  Â  "Department of Journalism and Communications": {Â 
Â  Â  Â  Â  courses: ["BA (Hons) Journalism & Mass Comm", "MA JMC"],Â 
Â  Â  Â  Â  years: ["1st Year", "2nd Year"],Â 
Â  Â  Â  Â  sections: ["A"]Â 
Â  Â  },
Â  Â  "Tula's Institute of Pharmacy": {Â 
Â  Â  Â  Â  courses: ["B.Pharm", "D.Pharm"],Â 
Â  Â  Â  Â  years: ["1st Year", "2nd Year", "3rd Year", "4th Year"],Â 
Â  Â  Â  Â  sections: ["A"]Â 
Â  Â  }
};

// --- CHATBOT CONFIG (UNCHANGED) ---
const CHAT_MODEL = 'gemini-2.5-flash-preview-09-2025';
const API_KEY = "";Â 

// === INITIALIZATION ===
document.addEventListener('DOMContentLoaded', () => {
Â  Â  initAuthDropdowns();
Â  Â  generateCaptcha();Â 
Â  Â  generateLoginCaptcha();Â 
Â  Â  if (currentUser) showDashboard(); else updateAuthUI();

Â  Â  // Login Handler (UNCHANGED)
Â  Â  document.getElementById('login-form').onsubmit = async (e) => {
Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  const loginCaptchaInput = document.getElementById('login-captcha-input').value.toUpperCase();
Â  Â  Â  Â  if (loginCaptchaInput !== currentLoginCaptcha) {
Â  Â  Â  Â  Â  Â  showToast('Incorrect Captcha. Please try again.', true);
Â  Â  Â  Â  Â  Â  generateLoginCaptcha();
Â  Â  Â  Â  Â  Â  document.getElementById('login-captcha-input').value = '';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const role = document.getElementById('login-role').value;
Â  Â  Â  Â  let dept = null;
Â  Â  Â  Â  if (role === 'Department Login') {
Â  Â  Â  Â  Â  Â  dept = document.getElementById('login-dept').value;
Â  Â  Â  Â  Â  Â  if (dept === 'Department of Engineering') {
Â  Â  Â  Â  Â  Â  Â  Â  dept = document.getElementById('login-eng-branch').value;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  await handleAuth('/login', {
Â  Â  Â  Â  Â  Â  userId: document.getElementById('login-id').value.trim(),
Â  Â  Â  Â  Â  Â  password: document.getElementById('login-pass').value,
Â  Â  Â  Â  Â  Â  role: role === 'Department Login' ? 'HOD' : role,
Â  Â  Â  Â  Â  Â  department: dept,
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // Signup Handler (UNCHANGED - Submits for admin approval)
Â  Â  document.getElementById('signup-form').onsubmit = async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const captchaInput = document.getElementById('captcha-input').value.toUpperCase();
Â  Â  Â  Â  if (captchaInput !== currentCaptcha) {
Â  Â  Â  Â  Â  Â  showToast('Incorrect Captcha. Please try again.', true);
Â  Â  Â  Â  Â  Â  generateCaptcha();
Â  Â  Â  Â  Â  Â  document.getElementById('captcha-input').value = '';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const formData = new FormData(e.target);
Â  Â  Â  Â  const payload = Object.fromEntries(formData);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!payload.email || !payload.email.toLowerCase().endsWith(REQUIRED_DOMAIN)) {
Â  Â  Â  Â  Â  Â  showToast(`Registration requires an email ending in ${REQUIRED_DOMAIN}.`, true);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (payload.role === 'Faculty') {
Â  Â  Â  Â  Â  Â  payload.userId = payload.email;
Â  Â  Â  Â  }

Â  Â  Â  Â  await handleAuth('/signup', payload, true);
Â  Â  };

Â  Â  // --- CHATBOT FORM LISTENER (UNCHANGED) ---
Â  Â  const chatForm = document.getElementById('chat-form');
Â  Â  if (chatForm) {
Â  Â  Â  Â  chatForm.onsubmit = async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const chatInput = document.getElementById('chat-input');
Â  Â  Â  Â  Â  Â  const chatSubmitBtn = document.getElementById('chat-submit-btn');
Â  Â  Â  Â  Â  Â  const loadingIndicator = document.getElementById('chat-loading-indicator');
Â  Â  Â  Â  Â  Â  const userQuery = chatInput.value.trim();

Â  Â  Â  Â  Â  Â  if (!userQuery) return;

Â  Â  Â  Â  Â  Â  addMessageToChat(userQuery, true);
Â  Â  Â  Â  Â  Â  chatInput.value = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  loadingIndicator.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  chatInput.disabled = true;
Â  Â  Â  Â  Â  Â  chatSubmitBtn.disabled = true;

Â  Â  Â  Â  Â  Â  const { text, sources } = await getGeminiResponse(userQuery);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  loadingIndicator.classList.add('hidden');
Â  Â  Â  Â  Â  Â  chatInput.disabled = false;
Â  Â  Â  Â  Â  Â  chatSubmitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  chatInput.focus();

Â  Â  Â  Â  Â  Â  addMessageToChat(text, false, sources);
Â  Â  Â  Â  };
Â  Â  }
});


// === AUTHENTICATION & UI HELPERS (RETAINED) ===

function initAuthDropdowns() {
Â  Â  const deptSelects = [document.getElementById('login-dept'), document.getElementById('signup-dept')];
Â  Â  const depts = Object.keys(DEPT_DATA);
Â  Â  deptSelects.forEach(sel => {
Â  Â  Â  Â  sel.innerHTML = '<option value="">Select Department</option>' +Â 
Â  Â  Â  Â  Â  Â  depts.map(d => `<option value="${d}">${d}</option>`).join('');
Â  Â  });
}

function updateAuthUI() {
Â  Â  const role = document.getElementById('login-role').value;
Â  Â  const isHOD = role === 'Department Login';
Â  Â  const deptWrapper = document.getElementById('login-dept-wrapper');
Â  Â  const branchSelect = document.getElementById('login-eng-branch');
Â  Â  const branchWrapper = document.getElementById('login-eng-branch-wrapper');
Â  Â Â 
Â  Â  deptWrapper.classList.toggle('hidden', !isHOD);
Â  Â Â 
Â  Â  if (isHOD && document.getElementById('login-dept').value === 'Department of Engineering') {
Â  Â  Â  Â  branchWrapper.classList.remove('hidden');
Â  Â  Â  Â  branchSelect.innerHTML = '<option value="">Select Branch</option>' +Â 
Â  Â  Â  Â  Â  Â  DEPT_DATA['Department of Engineering'].branches.map(b => `<option>${b}</option>`).join('');
Â  Â  } else {
Â  Â  Â  Â  branchWrapper.classList.add('hidden');
Â  Â  }
}

function updateSignupUI() {
Â  Â  const role = document.getElementById('signup-role').value;
Â  Â  const dept = document.getElementById('signup-dept').value;
Â  Â  const deptWrapper = document.getElementById('signup-dept-wrapper');
Â  Â  const courseWrapper = document.getElementById('signup-course-wrapper');
Â  Â  const courseSelect = document.getElementById('signup-course');
Â  Â  const studentFields = document.getElementById('student-fields');
Â  Â  const userIdInput = document.getElementById('signup-userid');

Â  Â  // 1. Show/Hide Department based on role
Â  Â  deptWrapper.classList.toggle('hidden', !role);

Â  Â  // 2. Handle Student Specifics
Â  Â  if (role === 'Student') {
Â  Â  Â  Â  studentFields.classList.remove('hidden');
Â  Â  Â  Â  userIdInput.required = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Show courses if dept is selected
Â  Â  Â  Â  if (dept && DEPT_DATA[dept]?.courses) {
Â  Â  Â  Â  Â  Â  courseWrapper.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  courseSelect.required = true;
Â  Â  Â  Â  Â  Â  courseSelect.innerHTML = '<option value="">Select Course</option>' +Â 
Â  Â  Â  Â  Â  Â  Â  Â  DEPT_DATA[dept].courses.map(c => `<option value="${c}">${c}</option>`).join('');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  courseWrapper.classList.add('hidden');
Â  Â  Â  Â  Â  Â  courseSelect.required = false;
Â  Â  Â  Â  }
Â  Â  }Â 
Â  Â  // 3. Handle Faculty Specifics
Â  Â  else if (role === 'Faculty') {
Â  Â  Â  Â  studentFields.classList.add('hidden');
Â  Â  Â  Â  userIdInput.required = false;
Â  Â  Â  Â  courseWrapper.classList.add('hidden');
Â  Â  Â  Â  courseSelect.required = false;
Â  Â  }Â 
Â  Â  // 4. Initial State
Â  Â  else {
Â  Â  Â  Â  studentFields.classList.add('hidden');
Â  Â  Â  Â  courseWrapper.classList.add('hidden');
Â  Â  }
}

function generateCaptcha(canvasId = 'captcha-canvas', setState) {
Â  Â  const canvas = document.getElementById(canvasId);
Â  Â  if (!canvas) return;

Â  Â  const ctx = canvas.getContext('2d');
Â  Â  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
Â  Â  let captchaText = '';

Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  ctx.fillStyle = '#f9fafb';
Â  Â  ctx.fillRect(0, 0, canvas.width, canvas.height);

Â  Â  for (let i = 0; i < 7; i++) {
Â  Â  Â  Â  ctx.strokeStyle = `rgba(${Math.random()*255},${Math.random()*255},${Math.random()*255},0.5)`;
Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
Â  Â  Â  Â  ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
Â  Â  Â  Â  ctx.stroke();
Â  Â  }

Â  Â  for (let i = 0; i < 6; i++) {
Â  Â  Â  Â  const char = chars.charAt(Math.floor(Math.random() * chars.length));
Â  Â  Â  Â  captchaText += char;
Â  Â  Â  Â  ctx.font = 'bold 24px Inter';
Â  Â  Â  Â  ctx.fillStyle = '#1f2937';
Â  Â  Â  Â Â 
Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  const x = 20 + i * 20;
Â  Â  Â  Â  const y = 30 + Math.random() * 10;
Â  Â  Â  Â  const angle = (Math.random() - 0.5) * 0.4;
Â  Â  Â  Â  ctx.translate(x, y);
Â  Â  Â  Â  ctx.rotate(angle);
Â  Â  Â  Â  ctx.fillText(char, 0, 0);
Â  Â  Â  Â  ctx.restore();
Â  Â  }
Â  Â Â 
Â  Â  if (canvasId === 'captcha-canvas') currentCaptcha = captchaText;
Â  Â  else if (canvasId === 'login-captcha-canvas') currentLoginCaptcha = captchaText;
}

function generateLoginCaptcha() { generateCaptcha('login-captcha-canvas'); }

async function handleAuth(endpoint, payload, isSignup = false) {
Â  Â  try {
Â  Â  Â  Â  showToast(isSignup ? 'Registering...' : 'Logging in...');
Â  Â  Â  Â  const res = await fetch(API_BASE + endpoint, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  if (isSignup) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.message || 'Registration submitted! Account pending admin approval.', false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  toggleAuthScreen('login');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('signup-form').reset();
Â  Â  Â  Â  Â  Â  Â  Â  generateCaptcha();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = data.user;
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('user', JSON.stringify(currentUser));
Â  Â  Â  Â  Â  Â  Â  Â  showDashboard();
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Welcome, ${currentUser.name}!`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast(data.message || 'Action failed', true);
Â  Â  Â  Â  Â  Â  if (isSignup) generateCaptcha();
Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  generateLoginCaptcha();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  showToast('Connection error. Please try again.', true);
Â  Â  Â  Â  if (!isSignup) generateLoginCaptcha();
Â  Â  }
}

function togglePass(id) { const i = document.getElementById(id); i.type = i.type==='password'?'text':'password'; }
function toggleAuthScreen(screen) {Â 
Â  Â  document.getElementById('login-box').classList.toggle('hidden', screen!=='login');Â 
Â  Â  document.getElementById('signup-box').classList.toggle('hidden', screen!=='signup');Â 
Â  Â  if (screen === 'signup') {
Â  Â  Â  Â  generateCaptcha();Â 
Â  Â  } else if (screen === 'login') {
Â  Â  Â  Â  generateLoginCaptcha();Â 
Â  Â  }
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
function logout() { sessionStorage.clear(); window.location.reload(); }
function showModal(html) { document.getElementById('modal-content').innerHTML = html; document.getElementById('modal').classList.remove('hidden'); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function showToast(msg, isErr=false) {Â 
Â  Â  const t = document.getElementById('toast');Â 
Â  Â  t.textContent = msg;Â 
Â  Â  t.className = `fixed bottom-5 right-5 transform translate-y-0 opacity-100 transition-all duration-300 z-50 px-6 py-3 rounded-lg shadow-2xl font-medium text-white ${isErr?'bg-red-600':'bg-green-600'}`;Â 
Â  Â  setTimeout(()=>t.classList.add('translate-y-full', 'opacity-0'), 3000);Â 
}

// === DASHBOARD & NAVIGATION (UPDATED) ===
function showDashboard() {
Â  Â  document.getElementById('auth-wrapper').classList.add('hidden');
Â  Â  document.getElementById('dashboard').classList.remove('hidden');
Â  Â  document.getElementById('nav-role-badge').textContent = currentUser.role.toUpperCase();
Â  Â  renderNavigation();
}

function renderNavigation() {
Â  Â  const nav = document.getElementById('nav-links');
Â  Â  nav.innerHTML = '';

Â  Â  const MENU_ITEMS = {
Â  Â  Â  Â  'Student': [
Â  Â  Â  Â  Â  Â  { id: 'profile', label: 'My Profile', icon: 'ğŸ‘¤' },
Â  Â  Â  Â  Â  Â  { id: 'timetable', label: 'Class Timetable', icon: 'ğŸ“…' },
Â  Â  Â  Â  Â  Â  { id: 'attendance', label: 'My Attendance', icon: 'ğŸ“Š' },
Â  Â  Â  Â  Â  Â  { id: 'assignments', label: 'Assignments', icon: 'ğŸ“' },
Â  Â  Â  Â  Â  Â  { id: 'marks', label: 'Exam Results', icon: 'ğŸ“' },
Â  Â  Â  Â  Â  Â  { id: 'leaves', label: 'Leave Application', icon: 'ğŸ“¨' },
Â  Â  Â  Â  Â  Â  { id: 'placements', label: 'Placements', icon: 'ğŸ’¼' }
Â  Â  Â  Â  ],
Â  Â  Â  Â  'Faculty': [
Â  Â  Â  Â  Â  Â  { id: 'profile', label: 'My Profile', icon: 'ğŸ‘¤' },
Â  Â  Â  Â  Â  Â  { id: 'fac-attendance', label: 'Mark Attendance', icon: 'âœ…' },
Â  Â  Â  Â  Â  Â  { id: 'fac-assignments', label: 'Manage Assignments', icon: 'ğŸ“š' },
Â  Â  Â  Â  Â  Â  { id: 'fac-leaves', label: 'Student Leaves', icon: 'ğŸ“«' },
Â  Â  Â  Â  Â  Â  { id: 'leaves', label: 'My Leave Req', icon: 'ğŸ“¨' },
Â  Â  Â  Â  Â  Â  { id: 'placements', label: 'Dept Placements', icon: 'ğŸ’¼' }
Â  Â  Â  Â  ],
Â  Â  Â  Â  'HOD': [
Â  Â  Â  Â  Â  Â  { id: 'profile', label: 'My Profile', icon: 'ğŸ‘¤' },
Â  Â  Â  Â  Â  Â  { id: 'admin-batches', label: 'Manage Batches', icon: 'ğŸ‘¥' },Â 
Â  Â  Â  Â  Â  Â  { id: 'admin-subjects', label: 'Assign Subjects', icon: 'ğŸ“–' }, // HOD KEEPS THIS
Â  Â  Â  Â  Â  Â  { id: 'fac-leaves', label: 'Approve Leaves', icon: 'âœ…' },
Â  Â  Â  Â  Â  Â  { id: 'admin-signup-requests', label: 'Sign-up Requests', icon: 'âœ‹' },Â 
Â  Â  Â  Â  Â  Â  { id: 'placements', label: 'Manage Placements', icon: 'ğŸ’¼' }
Â  Â  Â  Â  ],
Â  Â  Â  Â  'Admin': [
Â  Â  Â  Â  Â  Â  { id: 'profile', label: 'My Profile', icon: 'ğŸ‘¤' },
Â  Â  Â  Â  Â  Â  { id: 'admin-users', label: 'Manage Users', icon: 'ğŸ‘¥' },
Â  Â  Â  Â  Â  Â  { id: 'admin-batches', label: 'Manage Batches', icon: 'ğŸ‘¥' },Â 
Â  Â  Â  Â  Â  Â  // 'admin-subjects' REMOVED from Admin role
Â  Â  Â  Â  Â  Â  { id: 'admin-signup-requests', label: 'Sign-up Requests', icon: 'âœ‹' },Â 
Â  Â  Â  Â  Â  Â  { id: 'admin-id-cards', label: 'ID Card Requests', icon: 'ğŸ’³' },
Â  Â  Â  Â  Â  Â  { id: 'admin-announcements', label: 'Announcements', icon: 'ğŸ“¢' },
Â  Â  Â  Â  Â  Â  { id: 'placements', label: 'All Placements', icon: 'ğŸŒ' }
Â  Â  Â  Â  ]
Â  Â  };

Â  Â  (MENU_ITEMS[currentUser.role] || []).forEach(item => {
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.className = 'nav-link w-full flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-green-800 hover:text-white rounded-xl transition-all duration-200';
Â  Â  Â  Â  btn.innerHTML = `<span class="text-xl">${item.icon}</span><span class="font-medium">${item.label}</span>`;
Â  Â  Â  Â  btn.onclick = () => loadContent(item.id, btn);
Â  Â  Â  Â  nav.appendChild(btn);
Â  Â  });

Â  Â  if (nav.firstChild) nav.firstChild.click();
}

async function loadContent(pageId, activeBtn) {
Â  Â  document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active', 'bg-green-800', 'text-white'));
Â  Â  if (activeBtn) activeBtn.classList.add('active', 'bg-green-800', 'text-white');
Â  Â Â 
Â  Â  if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');

Â  Â  const container = document.getElementById('content-area');
Â  Â  container.innerHTML = '<div class="loader-wrapper"><div class="loader"></div></div>';Â 

Â  Â  try {
Â  Â  Â  Â  // --- FIX 1: Ensure currentUser exists before fetching data ---
Â  Â  Â  Â  if (!currentUser || !currentUser.id) throw new Error("User session invalid or expired. Please sign in.");Â 

Â  Â  Â  Â  switch (pageId) {
Â  Â  Â  Â  Â  Â  case 'profile': await loadProfile(container); break;
Â  Â  Â  Â  Â  Â  case 'timetable': await loadTimetable(container); break;
Â  Â  Â  Â  Â  Â  case 'attendance': await loadAttendance(container); break;
Â  Â  Â  Â  Â  Â  case 'marks': await loadMarks(container); break;
Â  Â  Â  Â  Â  Â  case 'assignments': await loadAssignmentsStudent(container); break;
Â  Â  Â  Â  Â  Â  case 'leaves': await loadLeavesCommon(container); break;
Â  Â  Â  Â  Â  Â  case 'fac-attendance': loadFacultyAttendance(container); break;Â 
Â  Â  Â  Â  Â  Â  case 'fac-assignments': await loadFacultyAssignments(container); break;
Â  Â  Â  Â  Â  Â  case 'fac-leaves': await loadFacultyLeaves(container); break;
Â  Â  Â  Â  Â  Â  case 'placements': await loadPlacements(container); break;
Â  Â  Â  Â  Â  Â  case 'admin-users': await loadAdminUsers(container); break;
Â  Â  Â  Â  Â  Â  case 'admin-id-cards': await loadAdminIdCards(container); break;
Â  Â  Â  Â  Â  Â  case 'admin-announcements': await loadAdminAnnouncements(container); break;
Â  Â  Â  Â  Â  Â  case 'admin-signup-requests': await showAdminSignupRequests(container); break;Â 
Â  Â  Â  Â  Â  Â  case 'admin-batches': await loadAdminBatches(container); break;Â 
Â  Â  Â  Â  Â  Â  case 'admin-subjects': await loadAdminSubjects(container); break;Â 
Â  Â  Â  Â  Â  Â  default: container.innerHTML = `<div class="text-center text-gray-400 py-20">Page Under Construction</div>`;
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  // This general catch handles all API fetch failures and the initial session check failure.
Â  Â  Â  Â  container.innerHTML = `<div class="bg-red-50 text-red-600 p-6 rounded-xl">Error loading content: ${err.message}. Please sign out and log in again.</div>`;
Â  Â  }
}

// =========================================
// === CORE FEATURE IMPLEMENTATIONS (RESTORED) ===
// =========================================

function detailItem(label, value) {
Â  Â  return `<div><p class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">${label}</p><p class="font-medium text-gray-900">${value}</p></div>`;
}


async function loadProfile(container) {
Â  Â  const res = await fetch(`${API_BASE}/profile/${currentUser.id}`);
Â  Â  const data = await res.json();
Â  Â  // --- FIX 2: Explicitly check for API failure on profile load ---
Â  Â  if (!data.success) throw new Error("Profile data not found on server.");Â 
Â  Â Â 
Â  Â  const p = data.profile;

Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="flex flex-col md:flex-row gap-8 items-start">
Â  Â  Â  Â  Â  Â  <div class="w-full md:w-1/3 bg-gradient-to-br from-green-50 to-white p-6 rounded-2xl border border-green-100 text-center shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="profile-photo-display" src="${p.photoUrl ? API_BASE+p.photoUrl : 'https://placehold.co/150?text='+p.name[0]}" class="w-32 h-32 mx-auto rounded-full object-cover border-4 border-white shadow-md mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">${p.name}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium mt-2">${p.role}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 mt-4 font-mono">${p.id}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showUserProfileEditForm('${p.id}')" class="mt-4 bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition">Edit Profile</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex-1 bg-gray-50 p-6 rounded-2xl w-full shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="bg-green-600 w-2 h-6 mr-3 rounded-full"></span> Personal Details
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${detailItem('Email', p.email)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${detailItem('Phone', p.phone || 'Not set')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${detailItem('Department', p.department)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.course ? detailItem('Course', p.course) : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${detailItem('Date of Birth', p.dob || 'Not set')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${detailItem('Address', p.address || 'Not set')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  `;
}

// Helper to render the edit form
window.showUserProfileEditForm = async (userId) => {
Â  Â  const res = await fetch(`${API_BASE}/profile/${userId}`);
Â  Â  const data = await res.json();
Â  Â  if (!data.success) { showToast("Failed to fetch profile for editing.", true); return; }
Â  Â  const p = data.profile;

Â  Â  showModal(`
Â  Â  Â  Â  <h3 class="text-xl font-bold mb-4">Edit Profile: ${p.name}</h3>
Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-4">You can only edit certain fields. Photo size limit: 10MB.</p>
Â  Â  Â  Â  <form onsubmit="submitProfileUpdate(event, '${p.id}')" class="space-y-4">
Â  Â  Â  Â  Â  Â  <input type="hidden" name="currentUserId" value="${currentUser.id}">

Â  Â  Â  Â  Â  Â  <label class="block">Full Name (Only editable by Admin)</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="name" value="${p.name || ''}" class="w-full p-3 border rounded-xl bg-gray-100 ${currentUser.role === 'Admin' ? 'bg-white' : 'cursor-not-allowed'}" ${currentUser.role !== 'Admin' ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <label class="block">Phone Number</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="phone" value="${p.phone || ''}" placeholder="Phone Number" class="w-full p-3 border rounded-xl">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <label class="block">Date of Birth</label>
Â  Â  Â  Â  Â  Â  <input type="date" name="dob" value="${p.dob || ''}" class="w-full p-3 border rounded-xl">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <label class="block">Blood Group (Optional)</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="bloodGroup" value="${p.bloodGroup || ''}" placeholder="Blood Group" class="w-full p-3 border rounded-xl">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <label class="block pt-2 border-t">Update Profile Photo (Max 10MB)</label>
Â  Â  Â  Â  Â  Â  <input type="file" name="photoFile" accept="image/jpeg,image/png" class="w-full p-2 border rounded-xl bg-gray-50">

Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">SAVE CHANGES</button>
Â  Â  Â  Â  </form>
Â  Â  `);
}

window.submitProfileUpdate = async (e, userId) => {
Â  Â  e.preventDefault();
Â  Â  const formData = new FormData(e.target);
Â  Â Â 
Â  Â  // Add the user ID to the form data for the server route
Â  Â  formData.append('userId', userId);
Â  Â Â 
Â  Â  showToast("Uploading and saving profile...", false);
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(API_BASE + '/profile/update', {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  body: formData // Must use FormData directly for file upload
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  // Update the session storage data immediately
Â  Â  Â  Â  Â  Â  sessionStorage.setItem('user', JSON.stringify(data.updatedUser));
Â  Â  Â  Â  Â  Â  currentUser = data.updatedUser;

Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  Â  showToast(data.message, false);
Â  Â  Â  Â  Â  Â  loadContent('profile'); // Reload profile view to show changes
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast(data.message || 'Profile update failed.', true);
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  showToast('Connection error during profile update.', true);
Â  Â  }
};

async function loadTimetable(container) {
Â  Â  const res = await fetch(`${API_BASE}/timetable?course=${encodeURIComponent(currentUser.course)}`);
Â  Â  const data = await res.json();
Â  Â  const tt = data.timetable || {};
Â  Â Â 
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Weekly Schedule <span class="text-gray-400 text-lg">(${currentUser.course})</span></h2>
Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
Â  Â  Â  Â  Â  Â  ${Object.entries(tt).map(([day, slots]) => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-md transition-shadow hover:shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-green-600 text-white p-3 font-bold">${day}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${slots.map(s => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm font-semibold text-green-700 w-24">${s.time}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-medium text-gray-900">${s.subject}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500">${s.faculty}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-gray-400">No classes</p>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  </div>`;
}

async function loadAttendance(container) {
Â  Â  const res = await fetch(`${API_BASE}/attendance/${currentUser.id}`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Attendance Record</h2>
Â  Â  Â  Â  <div class="overflow-hidden rounded-xl border border-gray-200 shadow-lg">
Â  Â  Â  Â  Â  Â  <table class="w-full text-left">
Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-gray-50 text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th class="p-4">Subject</th><th class="p-4">Attended / Total</th><th class="p-4">Percentage</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody class="divide-y divide-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${Object.entries(data.attendance).map(([sub, stats]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pct = (stats.present / stats.total * 100) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr class="hover:bg-gray-50 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4 font-medium">${sub}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4">${stats.present} / ${stats.total}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4"><span class="px-3 py-1 rounded-full text-sm font-medium ${pct < 75 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${pct.toFixed(1)}%</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('') || '<tr><td colspan="3" class="p-4 text-center text-gray-500">No attendance data found.</td></tr>'}
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>`;
}

async function loadMarks(container) {
Â  Â  const res = await fetch(`${API_BASE}/marks/${currentUser.id}`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Examination Results</h2>
Â  Â  Â  Â  <div class="grid gap-4 md:grid-cols-2">
Â  Â  Â  Â  Â  Â  ${data.marks.map(m => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-md flex justify-between items-center transition-transform hover:scale-[1.01]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-gray-800">${m.subject}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">${m.exam}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-2xl font-bold text-green-700">${m.marks}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-gray-400">/ ${m.total}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-gray-500 col-span-2 text-center py-10 bg-gray-50 rounded-xl">No marks available yet.</p>'}
Â  Â  Â  Â  </div>`;
}

async function loadAssignmentsStudent(container) {
Â  Â  const res = await fetch(`${API_BASE}/assignments?course=${encodeURIComponent(currentUser.course)}`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Course Assignments</h2>
Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  ${data.assignments.map(a => {
Â  Â  Â  Â  Â  Â  Â  Â  const isSubmitted = a.submissions.some(s => s.studentId === currentUser.id);
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md transition-shadow hover:shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-900">${a.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-sm text-green-700 font-medium">By: ${a.facultyName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs font-medium px-3 py-1 rounded-full ${isSubmitted ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isSubmitted ? 'Submitted' : 'Pending'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-4">${a.description}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${a.filePath ? `<a href="${a.filePath}" target="_blank" class="text-green-600 hover:underline text-sm flex items-center mb-4 transition">ğŸ“ Download Attachment</a>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center border-t pt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-gray-500">Due: ${new Date(a.dueDate).toLocaleDateString()}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${!isSubmitted ? `<button onclick="openSubmitModal(${a.id})" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition transform hover:scale-[1.01]">Submit Work</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }).join('') || '<p class="text-center py-12 bg-gray-50 rounded-xl text-gray-500">No assignments assigned yet.</p>'}
Â  Â  Â  Â  </div>`;
}

async function loadLeavesCommon(container) {
Â  Â  const res = await fetch(`${API_BASE}/leaves/${currentUser.id}`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">My Leave Applications</h2>
Â  Â  Â  Â  Â  Â  <button onclick="openLeaveModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center transition transform hover:scale-[1.02]">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xl mr-2">+</span> Apply New
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  ${data.leaves.map(l => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-5 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bold text-gray-800">${l.type}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-500">${new Date(l.fromDate).toLocaleDateString()} - ${new Date(l.toDate).toLocaleDateString()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mt-1">${l.reason}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-4 py-2 rounded-lg text-sm font-bold ${l.status==='Approved'?'bg-green-100 text-green-700':l.status==='Rejected'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${l.status}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-center py-10 text-gray-500 bg-gray-50 rounded-xl">No leave history found.</p>'}
Â  Â  Â  Â  </div>`;
}

async function loadFacultyAssignments(container) {
Â  Â  const res = await fetch(`${API_BASE}/assignments?facultyId=${currentUser.id}`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">Manage Assignments</h2>
Â  Â  Â  Â  Â  Â  <button onclick="openCreateAssignModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition transform hover:scale-[1.02]">+ Create New</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="grid gap-4">
Â  Â  Â  Â  Â  Â  ${data.assignments.map(a => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-md transition-shadow hover:shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg">${a.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm bg-gray-100 px-3 py-1 rounded-full">${a.course}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 text-sm mt-1">Due: ${new Date(a.dueDate).toLocaleDateString()}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 pt-4 border-t flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-green-700">${a.submissions.length} Submissions</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="text-blue-600 hover:underline text-sm transition">View All</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-gray-500 text-center py-10 bg-gray-50 rounded-xl">You haven\'t created any assignments yet.</p>'}
Â  Â  Â  Â  </div>`;
}

async function loadFacultyLeaves(container) {
Â  Â  const currentUserId = currentUser.id;
Â  Â  // CRITICAL: Passing currentUserId in query params for server authorization
Â  Â  const res = await fetch(`${API_BASE}/leaves/pending/${encodeURIComponent(currentUser.department)}?currentUserId=${currentUserId}`);
Â  Â  const data = await res.json();
Â  Â Â 
Â  Â  // Fetch my applications (to show in the history section)
Â  Â  const myLeavesRes = await fetch(`${API_BASE}/leaves/${currentUserId}`);
Â  Â  const myLeavesData = await myLeavesRes.json();
Â  Â  const myLeaves = myLeavesData.leaves || [];


Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Pending Leave Requests <span class="text-green-600">(${currentUser.department})</span></h2>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="space-y-4 mb-8">
Â  Â  Â  Â  Â  Â  ${data.leaves.map(l => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl border border-yellow-200 shadow-md transition-shadow hover:shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-lg text-gray-900">User ID: ${l.userId} (${l.department})</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">${l.type} | Applied: ${new Date(l.appliedOn).toLocaleDateString()}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right text-sm font-medium bg-green-50 text-green-800 px-3 py-1 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${new Date(l.fromDate).toLocaleDateString()} â” ${new Date(l.toDate).toLocaleDateString()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="bg-gray-50 p-4 rounded-lg text-gray-700 mb-4 italic">"${l.reason}"</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-3 justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateLeaveStatus(${l.id}, 'Rejected')" class="px-6 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition transform hover:scale-[1.01]">Reject</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateLeaveStatus(${l.id}, 'Approved')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-md transform hover:scale-[1.01]">Approve Request</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('') || '<div class="text-center py-16 bg-white rounded-xl border border-dashed border-gray-300 text-gray-500">ğŸ‰ No pending leave requests!</div>'}
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-800 mb-4 border-t pt-4">My Leave History (Faculty/HOD)</h3>
Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  ${myLeaves.map(l => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-5 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bold text-gray-800">${l.type}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-500">${new Date(l.fromDate).toLocaleDateString()} - ${new Date(l.toDate).toLocaleDateString()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mt-1">${l.reason}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-4 py-2 rounded-lg text-sm font-bold ${l.status==='Approved'?'bg-green-100 text-green-700':l.status==='Rejected'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${l.status}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-center py-5 text-gray-500 bg-gray-50 rounded-xl">No leave history found.</p>'}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
}

async function loadPlacements(container) {
Â  Â  let url = `${API_BASE}/placements`;
Â  Â  if (currentUser.role !== 'Admin') url += `?department=${encodeURIComponent(currentUser.department)}`;
Â  Â  const res = await fetch(url);
Â  Â  const data = await res.json();
Â  Â Â 
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">${currentUser.role === 'Admin' ? 'All' : 'Department'} Placements</h2>
Â  Â  Â  Â  Â  Â  ${['Admin', 'HOD'].includes(currentUser.role) ? `<button onclick="openPostPlacementModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition transform hover:scale-[1.02]">+ Post New</button>` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="grid gap-6">
Â  Â  Â  Â  Â  Â  ${data.placements.map(p => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl border-l-4 border-green-500 shadow-md hover:shadow-lg transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-900">${p.jobTitle} <span class="text-gray-400 font-normal">at</span> ${p.companyName}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-green-700 font-medium mt-1">${p.course} | ${p.department}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 my-4 line-clamp-2">${p.jobDescription}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-sm text-gray-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Posted: ${new Date(p.postedOn).toLocaleDateString()}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${currentUser.role === 'Student' ? '<button class="text-green-600 font-bold hover:underline transition">View Details & Apply â†’</button>' : `<span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full">${p.applications.length} Applicants</span>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-gray-500 text-center py-10 bg-gray-50 rounded-xl">No active placement drives.</p>'}
Â  Â  Â  Â  </div>`;
}

async function loadAdminUsers(container) {
Â  Â  const res = await fetch(`${API_BASE}/users`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">Manage Users (${data.users.length} Total)</h2>
Â  Â  Â  Â  Â  Â  <button onclick="openCreateHodModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition transform hover:scale-[1.02]">+ Create HOD Account</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-lg">
Â  Â  Â  Â  Â  Â  <table class="w-full text-left">
Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-gray-50 text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th class="p-4">Name/ID</th><th class="p-4">Role</th><th class="p-4">Department</th><th class="p-4">Email</th><th class="p-4">Action</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody class="divide-y divide-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${data.users.map(u => `<tr class="hover:bg-gray-50 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4">${u.name}<br><span class="text-xs text-gray-500 font-mono">${u.id}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">${u.role}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4 text-sm">${u.department || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4 text-sm">${u.email}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4"><button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-800 transition">ğŸ—‘ï¸</button></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  `;
}

async function deleteUser(userId) {
Â  Â  if (confirm(`Are you sure you want to delete user ${userId}?`)) {
Â  Â  Â  Â  await fetch(`${API_BASE}/users/${userId}`, { method: 'DELETE' });
Â  Â  Â  Â  showToast(`User ${userId} deleted.`, false);
Â  Â  Â  Â  loadContent('admin-users');Â 
Â  Â  }
}

async function loadAdminAnnouncements(container) {
Â  Â  const res = await fetch(`${API_BASE}/announcements?role=${currentUser.role}`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">Institute Announcements</h2>
Â  Â  Â  Â  Â  Â  <button onclick="openCreateAnnouncementModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition transform hover:scale-[1.02]">+ New Announcement</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  ${data.announcements.map(a => `<div class="bg-white p-5 rounded-xl border-l-4 border-blue-500 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg text-gray-900">${a.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mt-1">${a.body}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 text-xs text-gray-500 flex justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Target: ${a.target} (${a.department || 'All Depts'})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Posted: ${new Date(a.date).toLocaleDateString()}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`).join('') || '<p class="text-gray-500 text-center py-10 bg-gray-50 rounded-xl">No announcements posted yet.</p>'}
Â  Â  Â  Â  </div>
Â  Â  `;
}

async function loadAdminIdCards(container) {
Â  Â  const res = await fetch(`${API_BASE}/id-cards/pending`);
Â  Â  const data = await res.json();
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Pending ID Card Requests</h2>
Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  ${data.requests.map(r => `<div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${API_BASE}${r.photoUrl}" class="w-16 h-16 object-cover rounded-full border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-lg">${r.name} (${r.userId})</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">${r.course} - ${r.department}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-4 text-sm text-gray-700">Applied On: ${new Date(r.appliedOn).toLocaleDateString()}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-3 mt-4 justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateIdCardStatus(${r.id}, 'Rejected')" class="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition">Reject</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateIdCardStatus(${r.id}, 'Approved')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Approve</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`).join('') || '<p class="text-gray-500 text-center py-10 bg-gray-50 rounded-xl">No pending ID card requests.</p>'}
Â  Â  Â  Â  </div>
Â  Â  `;
}

async function updateIdCardStatus(id, status) {
Â  Â  await postData(`/id-cards/${id}/action`, { status });
Â  Â  loadContent('admin-id-cards');
Â  Â  showToast(`ID Card request ${status.toLowerCase()}`, false);
}

// =========================================
// === NEW BATCH MANAGEMENT IMPLEMENTATIONS ===
// =========================================

// --- 1. Admin/HOD Batch Management (NEW) ---

async function loadAdminBatches(container) {
Â  Â  container.innerHTML = '<div class="loader-wrapper"><div class="loader"></div></div>';
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  let url = `${API_BASE}/batches`;
Â  Â  Â  Â  const isHOD = currentUser.role === 'HOD';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Filter URL for HODs only
Â  Â  Â  Â  if (isHOD) {
Â  Â  Â  Â  Â  Â  url += `?department=${encodeURIComponent(currentUser.department)}&adminId=${currentUser.id}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  const batches = data.batches || [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  const isAdminOrHOD = currentUser.role === 'Admin' || currentUser.role === 'HOD';

Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">Manage Student Batches ${isHOD ? `(${currentUser.department})` : ''}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openEnrollBatchModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition transform hover:scale-[1.02]">Enroll Users</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openCreateBatchModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition transform hover:scale-[1.02]">+ Create Batch</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  ${batches.map(b => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg text-gray-900">${b.name} (${b.id})</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-green-700">${b.department} - ${b.course}, ${b.year}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mt-1">Subjects: ${b.subjects.length}, Students: ${b.students.length}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdminOrHOD ? `<button onclick="deleteBatch('${b.id}', '${currentUser.id}')" class="text-red-600 hover:text-red-800 transition p-2">ğŸ—‘ï¸ Delete</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-gray-500 text-center py-10 bg-gray-50 rounded-xl">No batches defined yet.</p>'}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  } catch (error) {
Â  Â  Â  Â  container.innerHTML = `<div class="bg-red-50 text-red-600 p-6 rounded-xl">Error fetching batches: ${error.message}</div>`;
Â  Â  }
}

async function loadAdminSubjects(container) {
Â  Â  Â container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow">
Â  Â  Â  Â  Â <h2 class="text-2xl font-bold mb-6">Assign Subjects & Teachers</h2>
Â  Â  Â  Â  Â <p class="text-gray-600">Here, Admin/HOD assigns subjects to a faculty member and links them to one or more batches (e.g., CS101 taught by F101 to Batch BTECH-CSE-Y1-A).</p>
Â  Â  Â  Â  Â <button onclick="openSubjectAssignmentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mt-4 transition">Assign Subject</button>
Â  Â  Â </div>`;
}

// --- 2. Faculty Attendance (UPDATED) ---

function loadFacultyAttendance(container) {
Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6">Mark Class Attendance</h2>
Â  Â  Â  Â  <div class="bg-white p-8 rounded-2xl border shadow-lg max-w-lg mx-auto">
Â  Â  Â  Â  Â  Â  <p class="text-red-500 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  **Note:** Select your assigned class to load the attendance sheet. (Use mock data: F101, BTECH-CSE-Y1-A, CS101)
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <form class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="att-faculty-id" value="${currentUser.id}">

Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium mb-1">Assigned Class</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="class-select" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-green-500 outline-none"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onchange="previewAttendanceSheet(this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select Subject and Batch</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="attendance-preview-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 mt-4">Select a class above to load the student list.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>`;
Â  Â  Â  Â Â 
Â  Â  // Initial fetch to populate the subject/batch dropdown
Â  Â  fetchFacultyAssignments();
}

// NEW HELPER: Fetch faculty assignments and populate the dropdown
async function fetchFacultyAssignments() {
Â  Â  const facultyId = currentUser.id;
Â  Â  const select = document.getElementById('class-select');
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${API_BASE}/faculty/attendance/data?facultyId=${facultyId}`);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const assignedSubjects = data.assignedSubjects || [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  let optionsHtml = '<option value="">Select Subject and Batch</option>';
Â  Â  Â  Â  if (assignedSubjects.length === 0) {
Â  Â  Â  Â  Â  Â  optionsHtml = '<option value="">No subjects assigned to you</option>';
Â  Â  Â  Â  Â  Â  select.innerHTML = optionsHtml;
Â  Â  Â  Â  Â  Â  select.disabled = true;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  assignedSubjects.forEach(subject => {
Â  Â  Â  Â  Â  Â  subject.batchIds.forEach(batchId => {
Â  Â  Â  Â  Â  Â  Â  Â  optionsHtml += `<option value="${subject.code},${batchId}">${subject.name} (${subject.code}) - Batch ${batchId}</option>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  select.innerHTML = optionsHtml;
Â  Â  Â  Â  select.disabled = false;

Â  Â  } catch (error) {
Â  Â  Â  Â  showToast('Error loading assignments for attendance.', true);
Â  Â  Â  Â  select.innerHTML = '<option value="">Error loading data</option>';
Â  Â  Â  Â  select.disabled = true;
Â  Â  }
}

// Function to fetch the student list and render the sheet
window.previewAttendanceSheet = async (selectedValue) => {
Â  Â  const previewArea = document.getElementById('attendance-preview-area');
Â  Â  if (!selectedValue) {
Â  Â  Â  Â  previewArea.innerHTML = '<p class="text-gray-500 mt-4">Select a class above to load the student list.</p>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  previewArea.innerHTML = '<div class="loader-small mx-auto"></div>';
Â  Â Â 
Â  Â  const [subjectCode, batchId] = selectedValue.split(',');

Â  Â  const res = await fetch(`${API_BASE}/faculty/attendance/data?facultyId=${currentUser.id}&batchId=${batchId}&subjectCode=${subjectCode}`);
Â  Â  const data = await res.json();

Â  Â  if (data.students && data.students.length > 0) {
Â  Â  Â  Â  renderAttendanceSheet(previewArea, data.students, batchId, subjectCode, data.currentBatchInfo.batchName);
Â  Â  } else {
Â  Â  Â  Â  Â previewArea.innerHTML = `<p class="text-red-500 mt-4">Could not load student list. Check batch or subject linkage.</p>`;
Â  Â  }
};

// Helper to render the student list attendance form
function renderAttendanceSheet(container, students, batchId, subjectCode, batchName) {
Â  Â  const studentsHtml = students.map(s => `
Â  Â  Â  Â  <tr class="hover:bg-gray-50 transition">
Â  Â  Â  Â  Â  Â  <td class="p-4 font-medium text-gray-800">${s.name} <span class="text-xs text-gray-500 font-mono">(${s.id})</span></td>
Â  Â  Â  Â  Â  Â  <td class="p-4 flex justify-around">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center space-x-1 cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="status_${s.id}" value="Present" required class="text-green-600 w-4 h-4"><span>P</span>
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center space-x-1 cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="status_${s.id}" value="Absent" required class="text-red-600 w-4 h-4"><span>A</span>
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');

Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 text-gray-800">Attendance: ${batchName}</h2>
Â  Â  Â  Â  <h3 class="text-md font-medium text-green-700 mb-6">Subject: ${subjectCode} (${students.length} students)</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <form id="attendance-sheet-form" onsubmit="submitAttendanceSheet(event, '${batchId}', '${subjectCode}')" class="space-y-4">
Â  Â  Â  Â  Â  Â  <input type="hidden" id="att-faculty-id" value="${currentUser.id}">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="overflow-hidden rounded-xl border border-gray-200 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-gray-50 text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th class="p-4">Student Name / ID</th><th class="p-4 text-center">Status</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody class="divide-y divide-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${studentsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition transform hover:scale-[1.01]">SUBMIT ATTENDANCE RECORD</button>
Â  Â  Â  Â  </form>
Â  Â  `;
}


// Function to process and submit the full attendance sheet
window.submitAttendanceSheet = async (e, batchId, subjectCode) => {
Â  Â  e.preventDefault();
Â  Â  showToast('Submitting attendance...', false);
Â  Â Â 
Â  Â  const facultyId = currentUser.id;
Â  Â  const formData = new FormData(e.target);
Â  Â Â 
Â  Â  let submissionSuccessCount = 0;
Â  Â  let submissionFailures = 0;

Â  Â  // Iterate through all radio button groups (status_SXXXXXXXX)
Â  Â  for (const [key, status] of formData.entries()) {
Â  Â  Â  Â  if (key.startsWith('status_')) {
Â  Â  Â  Â  Â  Â  const studentId = key.split('_')[1];Â 
Â  Â  Â  Â  Â  Â  const statusValue = status;Â 

Â  Â  Â  Â  Â  Â  if (statusValue) {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await postData('/attendance/mark', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  facultyId: facultyId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batchId: batchId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subjectCode: subjectCode,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  studentId: studentId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: statusValue
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (res.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submissionSuccessCount++;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submissionFailures++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 3. Provide feedback and reset the view
Â  Â  if (submissionSuccessCount > 0) {
Â  Â  Â  Â  showToast(`Attendance submitted for ${submissionSuccessCount} students!`, false);
Â  Â  }
Â  Â  if (submissionFailures > 0) {
Â  Â  Â  Â  showToast(`${submissionFailures} students failed to submit. Try checking the server logs.`, true);
Â  Â  }
Â  Â Â 
Â  Â  // Reload the main attendance selection screen
Â  Â  loadFacultyAttendance(document.getElementById('content-area'));
};


// --- 3. Admin Approval (UPDATED for Faculty ID Assignment) ---

async function showAdminSignupRequests(container) {
Â  Â  container.innerHTML = '<div class="loader-wrapper"><div class="loader"></div></div>';
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${API_BASE}/signup-requests/pending`);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  const requests = data.requests || [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Pending Sign-up Requests <span class="text-yellow-600">(${requests.length})</span></h2>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  ${requests.map(r => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl border border-yellow-200 shadow-md transition-shadow hover:shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg text-gray-900">${r.name} (${r.userId})</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600">${r.role} - ${r.department} (${r.course || 'N/A'})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mt-2">Email: ${r.email} | Phone: ${r.phone}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-3 mt-4 justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="manageSignupRequest(${r.id}, 'reject')" class="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition">Reject</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="handleApprovalFlow('${r.id}', '${r.role}', '${r.userId}', '${r.email}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Approve</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('') || '<p class="text-gray-500 text-center py-10 bg-gray-50 rounded-xl">No pending sign-up requests.</p>'}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  } catch (error) {
Â  Â  Â  Â  container.innerHTML = `<div class="bg-red-50 text-red-600 p-6 rounded-xl">Error fetching requests: ${error.message}</div>`;
Â  Â  }
}

// NEW HANDLER: Captures Faculty ID before calling approval
window.handleApprovalFlow = (id, role, currentId, email) => {
Â  Â  if (role === 'Student') {
Â  Â  Â  Â  // Students use their registered userId/Roll No. directly
Â  Â  Â  Â  manageSignupRequest(id, 'approve', currentId);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // Logic for Faculty/HOD: Requires Admin to assign a new ID
Â  Â  showModal(`
Â  Â  Â  Â  <h3 class="text-xl font-bold mb-4">Assign Official ID (${role})</h3>
Â  Â  Â  Â  <p class="text-gray-600">Enter the official ID for: <strong>${email}</strong></p>
Â  Â  Â  Â  <form onsubmit="event.preventDefault(); submitNewUserId('${id}', this.newUserId.value)" class="space-y-4 mt-4">
Â  Â  Â  Â  Â  Â  <input type="text" name="newUserId" placeholder="Enter official ID (e.g., F201 or HOD05)" required class="w-full p-3 border rounded-xl" value="${role === 'Faculty' ? 'F' : 'HOD'}">
Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">CONFIRM ID & APPROVE</button>
Â  Â  Â  Â  </form>
Â  Â  `);
};

// NEW HANDLER: Submits the final approval with the provided new ID
window.submitNewUserId = async (id, newUserId) => {
Â  Â  closeModal(); // Close the intermediate modal
Â  Â Â 
Â  Â  // Call the core handler with the new ID as the optional parameter
Â  Â  await manageSignupRequest(id, 'approve', newUserId);
};


// CORE HANDLER: Now accepts an optional newUserId
window.manageSignupRequest = async (id, action, newUserId = null) => {
Â  Â  const endpoint = `/signup-requests/${id}/${action}`;
Â  Â  const actionMsg = action === 'approve' ? 'Approving...' : 'Rejecting...';
Â  Â Â 
Â  Â  showToast(actionMsg, false);
Â  Â Â 
Â  Â  // Construct payload only if newUserId is provided (for faculty approval)
Â  Â  const payload = newUserId ? { newUserId } : {};

Â  Â  try {
Â  Â  Â  Â  // Use postData which sends JSON payload
Â  Â  Â  Â  const res = await postData(endpoint, payload);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (res.success) {
Â  Â  Â  Â  Â  Â  showToast(res.message, false);
Â  Â  Â  Â  Â  Â  // Refresh the requests list
Â  Â  Â  Â  Â  Â  await showAdminSignupRequests(document.getElementById('content-area'));Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast(res.message, true);
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  showToast('Connection error during request management.', true);
Â  Â  }
};


// --- 4. Modals and Handlers for Batch Management (NEW) ---

window.openCreateHodModal = () => showModal(`
Â  Â  <h3 class="text-xl font-bold mb-4">Create New Department Head (HOD)</h3>
Â  Â  <p class="text-gray-600 mb-4">Assigns credentials directly to a new HOD for immediate use.</p>
Â  Â  <form onsubmit="submitCreateHod(event)" class="space-y-4">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <input name="id" placeholder="Official HOD ID (e.g., HOD-MECH)" required class="w-full p-3 border rounded-xl">
Â  Â  Â  Â  <input type="password" name="pass" placeholder="Password" required class="w-full p-3 border rounded-xl">
Â  Â  Â  Â  <input name="name" placeholder="Full Name (Optional, e.g., Prof. Jane Doe)" class="w-full p-3 border rounded-xl">

Â  Â  Â  Â  <h4 class="font-bold pt-2 border-t">Department Assignment</h4>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select name="department" id="hod-dept-select" onchange="populateHODCourseSelect(this.value)" required class="w-full p-3 border rounded-xl">
Â  Â  Â  Â  Â  Â  <option value="">Select Department</option>
Â  Â  Â  Â  Â  Â  ${Object.keys(DEPT_DATA).map(d => `<option value="${d}">${d}</option>`).join('')}
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select name="course" id="hod-course-select" class="w-full p-3 border rounded-xl" required disabled>
Â  Â  Â  Â  Â  Â  <option value="">Select Course/Specialization</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <input type="email" name="email" placeholder="Email (Optional, institutional)" class="w-full p-3 border rounded-xl">

Â  Â  Â  Â  <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">CREATE ACCOUNT</button>
Â  Â  </form>
`);

// Helper for HOD Course Selection
window.populateHODCourseSelect = (department) => {
Â  Â  const courseSelect = document.getElementById('hod-course-select');
Â  Â  courseSelect.innerHTML = '<option value="">Select Course/Specialization</option>';

Â  Â  if (department && DEPT_DATA[department] && DEPT_DATA[department].courses) {
Â  Â  Â  Â  DEPT_DATA[department].courses.forEach(course => {
Â  Â  Â  Â  Â  Â  courseSelect.innerHTML += `<option value="${course}">${course}</option>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  courseSelect.disabled = false;
Â  Â  } else {
Â  Â  Â  Â  courseSelect.disabled = true;
Â  Â  }
};

window.submitCreateHod = async (e) => {
Â  Â  e.preventDefault();
Â  Â  const formData = Object.fromEntries(new FormData(e.target));
Â  Â Â 
Â  Â  // Ensure the ID is uppercase
Â  Â  formData.id = formData.id.toUpperCase().trim();
Â  Â Â 
Â  Â  showToast("Creating HOD account...", false);

Â  Â  const res = await postData('/admin/create-hod', formData);

Â  Â  if (res.success) {
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  showToast(res.message, false);
Â  Â  Â  Â  // CRITICAL: Reloads the Admin Users page
Â  Â  Â  Â  loadContent('admin-users');Â 
Â  Â  } else {
Â  Â  Â  Â  showToast(res.message || "Failed to create HOD account.", true);
Â  Â  }
};


window.openCreateBatchModal = () => showModal(`
Â  Â  <h3 class="text-xl font-bold mb-4">Create New Batch</h3>
Â  Â  <form id="create-batch-form" onsubmit="submitCreateBatch(event)" class="space-y-4">
Â  Â  Â  Â  <input name="batchId" placeholder="Batch ID (e.g., BTECH-CSE-Y1-A)" required class="w-full p-3 border rounded-xl">
Â  Â  Â  Â  <select name="department" id="batch-dept" onchange="populateBatchSelects('batch-dept', 'batch-course', 'batch-year', 'batch-section')" class="w-full p-3 border rounded-xl" required><option value="">Select Department</option>${Object.keys(DEPT_DATA).map(d => `<option value="${d}">${d}</option>`).join('')}</select>
Â  Â  Â  Â  <select name="course" id="batch-course" onchange="populateBatchSelects('batch-dept', 'batch-course', 'batch-year', 'batch-section')" class="w-full p-3 border rounded-xl" required disabled><option value="">Select Course</option></select>
Â  Â  Â  Â  <select name="year" id="batch-year" onchange="populateBatchSelects('batch-dept', 'batch-course', 'batch-year', 'batch-section')" class="w-full p-3 border rounded-xl" required disabled><option value="">Select Year</option></select>
Â  Â  Â  Â  <select name="section" id="batch-section" class="w-full p-3 border rounded-xl" required disabled><option value="">Select Section</option></select>
Â  Â  Â  Â  <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">CREATE BATCH</button>
Â  Â  </form>
`);

// Helper to populate dependent selects for batch creation
window.populateBatchSelects = (deptId, courseId, yearId, sectionId) => {
Â  Â  const dept = document.getElementById(deptId).value;
Â  Â  const courseSelect = document.getElementById(courseId);
Â  Â  const yearSelect = document.getElementById(yearId);
Â  Â  const sectionSelect = document.getElementById(sectionId);
Â  Â Â 
Â  Â  const data = DEPT_DATA[dept];
Â  Â Â 
Â  Â  const populateAndEnable = (select, values, defaultText, isEnabled) => {
Â  Â  Â  Â  const currentValue = select.value;
Â  Â  Â  Â  select.innerHTML = `<option value="">${defaultText}</option>`;
Â  Â  Â  Â  select.disabled = !isEnabled;
Â  Â  Â  Â  if (values) {
Â  Â  Â  Â  Â  Â  values.forEach(val => {
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML += `<option value="${val}" ${val === currentValue ? 'selected' : ''}>${val}</option>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  };

Â  Â  if (dept && data) {
Â  Â  Â  Â  populateAndEnable(courseSelect, data.courses, 'Select Course', true);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const courseSelected = courseSelect.value;
Â  Â  Â  Â  if (courseSelected && data.years) {
Â  Â  Â  Â  Â  Â  populateAndEnable(yearSelect, data.years, 'Select Year', true);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const yearSelected = yearSelect.value;
Â  Â  Â  Â  Â  Â  if (yearSelected && data.sections) {
Â  Â  Â  Â  Â  Â  Â  Â  populateAndEnable(sectionSelect, data.sections, 'Select Section', true);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â populateAndEnable(sectionSelect, null, 'Select Section', false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  populateAndEnable(yearSelect, null, 'Select Year', false);
Â  Â  Â  Â  Â  Â  populateAndEnable(sectionSelect, null, 'Select Section', false);
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  populateAndEnable(courseSelect, null, 'Select Course', false);
Â  Â  Â  Â  populateAndEnable(yearSelect, null, 'Select Year', false);
Â  Â  Â  Â  populateAndEnable(sectionSelect, null, 'Select Section', false);
Â  Â  }
};

async function submitCreateBatch(e) {
Â  Â  e.preventDefault();
Â  Â  const formData = Object.fromEntries(new FormData(e.target));
Â  Â  formData.section = formData.section.toUpperCase();Â 
Â  Â Â 
Â  Â  const res = await postData('/batches', formData);

Â  Â  if (res.success) {
Â  Â  Â  Â  closeModal();Â 
Â  Â  Â  Â  setTimeout(() => loadContent('admin-batches'), 100);Â 
Â  Â  Â  Â  showToast(res.message);
Â  Â  } else {
Â  Â  Â  Â  showToast(res.message, true);
Â  Â  }
}

window.openEnrollBatchModal = () => showModal(`
Â  Â  <h3 class="text-xl font-bold mb-4">Enroll Users into Batch</h3>
Â  Â  <p class="text-sm text-gray-600 mb-4">Assign students and faculty to a specific batch.</p>
Â  Â  <form onsubmit="submitEnrollBatch(event)" class="space-y-4">
Â  Â  Â  Â  <input name="batchId" placeholder="Existing Batch ID (e.g., BTECH-CSE-Y1-A)" required class="w-full p-3 border rounded-xl">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h4 class="font-bold pt-4 border-t">1. Enroll Students (Student IDs, comma-separated)</h4>
Â  Â  Â  Â  <textarea name="studentIds" placeholder="S2024001, S2024002, ..." class="w-full p-3 border rounded-xl h-20"></textarea>

Â  Â  Â  Â  <h4 class="font-bold pt-4 border-t">2. Assign Faculty to Subjects</h4>
Â  Â  Â  Â  <div id="subject-assignments" class="space-y-2">
Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">Subject Code and Faculty ID must match existing users/subjects.</p>
Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  <input name="subject_0_code" placeholder="Subject Code (e.g., CS101)" class="w-1/2 p-2 border rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  <input name="subject_0_faculty" placeholder="Faculty ID (e.g., F101)" class="w-1/2 p-2 border rounded-xl">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button type="button" onclick="addSubjectAssignmentRow()" class="text-sm text-blue-600 hover:underline"> + Add Subject/Faculty Assignment</button>

Â  Â  Â  Â  <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">ENROLL & ASSIGN</button>
Â  Â  </form>
`);

let assignmentRowCount = 1;
window.addSubjectAssignmentRow = () => {
Â  Â  const container = document.getElementById('subject-assignments');
Â  Â  const newRow = document.createElement('div');
Â  Â  newRow.className = 'flex space-x-2';
Â  Â  newRow.innerHTML = `
Â  Â  Â  Â  <input name="subject_${assignmentRowCount}_code" placeholder="Subject Code" class="w-1/2 p-2 border rounded-xl">
Â  Â  Â  Â  <input name="subject_${assignmentRowCount}_faculty" placeholder="Faculty ID" class="w-1/2 p-2 border rounded-xl">
Â  Â  `;
Â  Â  container.appendChild(newRow);
Â  Â  assignmentRowCount++;
};

async function submitEnrollBatch(e) {
Â  Â  e.preventDefault();
Â  Â  const rawFormData = new FormData(e.target);
Â  Â  const payload = {
Â  Â  Â  Â  batchId: rawFormData.get('batchId'),
Â  Â  Â  Â  studentIds: (rawFormData.get('studentIds') || '').split(',').map(id => id.trim()).filter(id => id),
Â  Â  Â  Â  subjectAssignments: []
Â  Â  };
Â  Â Â 
Â  Â  for (let i = 0; i < assignmentRowCount; i++) {
Â  Â  Â  Â  const code = rawFormData.get(`subject_${i}_code`);
Â  Â  Â  Â  const faculty = rawFormData.get(`subject_${i}_faculty`);
Â  Â  Â  Â  if (code && faculty) {
Â  Â  Â  Â  Â  Â  payload.subjectAssignments.push({ courseCode: code, teacherId: faculty });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  const res = await postData('/batches/enroll', payload);
Â  Â Â 
Â  Â  if (res.success) {
Â  Â  Â  Â  closeModal();Â 
Â  Â  Â  Â  setTimeout(() => loadContent('admin-batches'), 100);Â 
Â  Â  Â  Â  showToast(res.message);
Â  Â  } else {
Â  Â  Â  Â  showToast(res.message, true);
Â  Â  }
}

// --- 5. Modal Handlers (RETAINED) ---

window.openLeaveModal = () => showModal(`<h3 class="text-xl font-bold mb-4">Apply for Leave</h3><form onsubmit="submitLeave(event)" class="space-y-4"><select name="type" class="w-full p-3 border rounded-xl"><option>Sick Leave</option><option>Casual Leave</option><option>Emergency</option></select><div class="grid grid-cols-2 gap-4"><input type="date" name="fromDate" required class="p-3 border rounded-xl"><input type="date" name="toDate" required class="p-3 border rounded-xl"></div><textarea name="reason" placeholder="Reason for leave..." required class="w-full p-3 border rounded-xl h-32"></textarea><button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">SUBMIT APPLICATION</button></form>`);
window.openCreateAssignModal = () => showModal(`<h3 class="text-xl font-bold mb-4">Create Assignment</h3><form onsubmit="submitCreateAssign(event)" class="space-y-4"><input name="title" placeholder="Assignment Title" required class="w-full p-3 border rounded-xl"><textarea name="description" placeholder="Instructions..." class="w-full p-3 border rounded-xl h-24"></textarea><input name="course" placeholder="Target Course (e.g. BCA)" required class="w-full p-3 border rounded-xl"><div class="grid grid-cols-2 gap-4"><div class="flex flex-col"><label class="text-sm mb-1 font-medium">Due Date</label><input type="date" name="dueDate" required class="p-3 border rounded-xl"></div><div class="flex flex-col"><label class="text-sm mb-1 font-medium">Attachment (Optional)</label><input type="file" name="assignmentFile" class="p-2 border rounded-xl bg-gray-50"></div></div><button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">POST ASSIGNMENT</button></form>`);
window.openSubmitModal = (id) => showModal(`<h3 class="text-xl font-bold mb-4">Submit Assignment</h3><form onsubmit="submitWork(event, ${id})" class="space-y-4"><div class="p-4 bg-blue-50 text-blue-800 rounded-xl text-sm mb-4">Ensure your file is in PDF or DOCX format.</div><input type="file" name="submissionFile" required class="w-full p-3 border rounded-xl bg-gray-50"><button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold transition">UPLOAD & TURN IN</button></form>`);
window.openPostPlacementModal = () => showModal(`<h3 class="text-xl font-bold mb-4">Post Placement Drive</h3><form onsubmit="submitPlacement(event)" class="space-y-4"><input name="companyName" placeholder="Company Name" required class="w-full p-3 border rounded-xl"><input name="jobTitle" placeholder="Job Role/Title" required class="w-full p-3 border rounded-xl"><textarea name="jobDescription" placeholder="Job Description & Requirements..." required class="w-full p-3 border rounded-xl h-32"></textarea><select name="department" required class="w-full p-3 border rounded-xl"><option value="">Target Department</option>${Object.keys(DEPT_DATA).map(d=>`<option>${d}</option>`).join('')}</select><input name="course" placeholder="Target Course (e.g. B.Tech CSE)" required class="w-full p-3 border rounded-xl"><button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">PUBLISH DRIVE</button></form>`);
window.openCreateAnnouncementModal = () => showModal(`<h3 class="text-xl font-bold mb-4">Create New Announcement</h3><form onsubmit="submitAnnouncement(event)" class="space-y-4"><input name="title" placeholder="Title" required class="w-full p-3 border rounded-xl"><textarea name="body" placeholder="Announcement Details..." required class="w-full p-3 border rounded-xl h-24"></textarea><select name="target" required class="w-full p-3 border rounded-xl"><option value="All">All Users</option><option value="Student">Students Only</option><option value="Faculty">Faculty Only</option></select><select name="department" class="w-full p-3 border rounded-xl mt-2"><option value="">All Departments (or select one)</option>${Object.keys(DEPT_DATA).map(d=>`<option>${d}</option>`).join('')}</select><button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold transition">PUBLISH ANNOUNCEMENT</button></form>`);

// --- 6. Form Submission Handlers (RETAINED) ---

async function submitLeave(e) {
Â  Â  e.preventDefault();
Â  Â  const formData = Object.fromEntries(new FormData(e.target));

Â  Â  // CRITICAL: Send the userId to the server so it can determine the mentorId (approvalTarget)
Â  Â  const payload = {
Â  Â  Â  Â  userId: currentUser.id,Â 
Â  Â  Â  Â  department: currentUser.department,
Â  Â  Â  Â  ...formData
Â  Â  };
Â  Â Â 
Â  Â  const res = await postData('/leaves', payload);
Â  Â Â 
Â  Â  closeModal();Â 
Â  Â  setTimeout(() => loadContent('leaves'), 100);Â 
Â  Â  showToast(res.message || 'Leave application submitted');
}
async function submitCreateAssign(e) {
Â  Â  e.preventDefault();
Â  Â  const fd = new FormData(e.target);
Â  Â  fd.append('facultyId', currentUser.id); fd.append('facultyName', currentUser.name); fd.append('department', currentUser.department);
Â  Â  await fetch(API_BASE+'/assignments', {method:'POST', body:fd});
Â  Â  closeModal();Â 
Â  Â  setTimeout(() => loadContent('fac-assignments'), 100);Â 
Â  Â  showToast('Assignment created');
}
async function submitWork(e, id) {
Â  Â  e.preventDefault();
Â  Â  const fd = new FormData(e.target);
Â  Â  fd.append('studentId', currentUser.id); fd.append('studentName', currentUser.name);
Â  Â  await fetch(API_BASE+`/assignments/${id}/submit`, {method:'POST', body:fd});
Â  Â  closeModal();Â 
Â  Â  setTimeout(() => loadContent('assignments'), 100);Â 
Â  Â  showToast('Work submitted successfully!');
}
async function updateLeaveStatus(id, status) {
Â  Â  await postData(`/leaves/${id}/action`, {status});
Â  Â  setTimeout(() => loadContent('fac-leaves'), 100);Â 
Â  Â  showToast(`Leave ${status.toLowerCase()}`);
}
async function submitPlacement(e) {
Â  Â  e.preventDefault();
Â  Â  await postData('/placements', Object.fromEntries(new FormData(e.target)));
Â  Â  closeModal();Â 
Â  Â  setTimeout(() => loadContent('placements'), 100);Â 
Â  Â  showToast('Placement drive published');
}
async function submitAnnouncement(e) {
Â  Â  e.preventDefault();
Â  Â  await postData('/announcements', Object.fromEntries(new FormData(e.target)));
Â  Â  closeModal();
Â  Â  setTimeout(() => loadContent('admin-announcements'), 100);
Â  Â  showToast('Announcement posted');
}


async function postData(url, data, extra={}) {
Â  Â  const res = await fetch(API_BASE+url, {Â 
Â  Â  Â  Â  method:'POST',Â 
Â  Â  Â  Â  headers:{'Content-Type':'application/json'},Â 
Â  Â  Â  Â  body:JSON.stringify({...data, ...extra})Â 
Â  Â  });
Â  Â  return res.json();Â 
}

// --- 7. Chatbot Logic (IMPLEMENTED DUMMIES TO PREVENT CRASH) ---

function addMessageToChat(text, isUser, sources = []) {
    const history = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    msgDiv.className = isUser ? 'flex justify-end' : 'flex justify-start';
    msgDiv.innerHTML = `<div class="${isUser ? 'bg-green-500 text-white rounded-xl rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-xl rounded-bl-none'} p-3 max-w-[80%] chat-bubble">${text}</div>`;
    history.appendChild(msgDiv);
    history.scrollTop = history.scrollHeight;
}

async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
    return {
        ok: true,
        json: async () => ({
            text: "Sorry, the full AI model integration is still pending. I can only echo messages or provide static replies for now!",
            sources: []
        })
    };
}
async function getGeminiResponse(userQuery) {
    const response = await fetchWithBackoff(API_BASE + '/gemini-mock', {});
    const data = await response.json();
    return data;
}
window.toggleChatbot = () => {
    document.getElementById('chatbot-modal').classList.toggle('hidden');
}


</script>
</body>
</html>