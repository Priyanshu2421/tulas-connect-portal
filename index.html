<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TULA'S CONNECT - ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50">

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-full opacity-0 transition-all duration-500 z-50 px-6 py-3 rounded-lg shadow-2xl font-medium text-white"></div>

    <!-- Generic Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative">
             <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition text-2xl">&times;</button>
             <div id="modal-content" class="p-6"></div>
        </div>
    </div>

    <!-- AUTHENTICATION WRAPPER - ABSOLUTE CENTERING -->
    <div id="auth-wrapper" class="fixed inset-0 w-full h-full flex items-center justify-center p-4 z-50" style="display: none;">
        
        <!-- LOGIN SECTION -->
        <div id="login-box" class="auth-card transition-all duration-300 relative z-10">
            <div class="auth-header text-center mb-8">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" onerror="this.src='https://placehold.co/64x64/22c55e/ffffff?text=TL'" alt="Logo" class="mx-auto mb-4 h-16">
                <h1 class="text-gray-900 font-black text-2xl tracking-tight uppercase">Tula's Connect</h1>
                <!-- TAGLINE ADDED HERE -->
                <p class="text-green-600 text-sm font-semibold italic mt-1 uppercase tracking-tighter">"Connecting Communities, Empowering Futures"</p>
                <p class="text-gray-400 text-[10px] uppercase tracking-widest mt-1 font-bold">Enterprise Resource Portal</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div class="input-group">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1 text-left">Access Level</label>
                    <select id="login-role" onchange="updateAuthUI()" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                        <option>Student</option>
                        <option>Faculty</option>
                        <option value="Department Login">Department Head (HOD)</option>
                        <option>Admin</option>
                    </select>
                </div>
                
                <div id="login-dept-wrapper" class="hidden space-y-4 text-left">
                    <div class="input-group">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Department</label>
                        <select id="login-dept" onchange="updateAuthUI()" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"></select>
                    </div>
                    <div id="login-eng-branch-wrapper" class="hidden input-group">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Engineering Branch</label>
                        <select id="login-eng-branch" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"></select>
                    </div>
                </div>

                <div class="input-group text-left">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">User ID / Roll No</label>
                    <input type="text" id="login-id" required placeholder="Enter your ID" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                </div>
                
                <div class="input-group relative text-left">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Password</label>
                    <input type="password" id="login-pass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                    <button type="button" onclick="togglePass('login-pass')" class="absolute right-3 top-8 text-gray-400 hover:text-green-600 transition">üëÅÔ∏è</button>
                </div>

                <div class="space-y-2 text-left">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Verification</label>
                    <div class="flex items-center space-x-3 bg-white/50 p-2 rounded-lg border border-gray-200">
                        <canvas id="login-captcha-canvas" width="120" height="40" onclick="generateLoginCaptcha()" class="rounded border shadow-sm cursor-pointer"></canvas>
                        <button type="button" onclick="generateLoginCaptcha()" class="text-gray-400 hover:text-green-600 transition p-2">üîÑ</button>
                        <input type="text" id="login-captcha-input" placeholder="Code" required class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                </div>

                <button type="submit" class="btn-primary w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg mt-4">SECURE LOGIN</button>
            </form>

            <div class="mt-8 text-center border-t pt-6">
                <p class="text-sm text-gray-600">New student? <button onclick="toggleAuthScreen('signup')" class="text-green-700 font-bold hover:underline">Create Account</button></p>
            </div>
        </div>

        <!-- SIGNUP SECTION -->
        <div id="signup-box" class="hidden auth-card transition-all duration-300 relative z-10 max-h-[90vh] overflow-y-auto">
            <div class="auth-header text-center mb-6">
                <h2 class="text-2xl font-black text-gray-900 tracking-tight uppercase leading-tight">Registration</h2>
                <!-- TAGLINE ADDED HERE -->
                <p class="text-green-600 text-xs font-semibold italic mt-1 uppercase tracking-tighter">"Connecting Communities, Empowering Futures"</p>
            </div>
            <form id="signup-form" class="space-y-3 text-left">
                <div class="input-group">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Role Selection</label>
                    <select name="role" id="signup-role" required onchange="updateSignupUI()" class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                        <option value="">Select Role</option>
                        <option value="Student">Student</option>
                        <option value="Faculty">Faculty</option>
                    </select>
                </div>

                <input type="text" name="name" placeholder="Full Legal Name" required class="w-full p-3 bg-gray-50 border rounded-xl">
                <input type="email" name="email" placeholder="Email (@tulas.edu.in)" required class="w-full p-3 bg-gray-50 border rounded-xl">
                <input type="tel" name="phone" placeholder="Phone Number" required class="w-full p-3 bg-gray-50 border rounded-xl">

                <div id="student-fields" class="hidden">
                    <input type="text" name="userId" id="signup-userid" placeholder="University Roll No." class="w-full p-3 bg-gray-50 border rounded-xl mt-3">
                </div>

                <div id="signup-dept-wrapper" class="hidden mt-3">
                    <select name="department" id="signup-dept" required onchange="updateSignupUI()" class="w-full p-3 bg-gray-50 border rounded-xl">
                        <option value="">Select Department</option>
                    </select>
                </div>

                <div id="signup-course-wrapper" class="hidden mt-3">
                    <select name="course" id="signup-course" class="w-full p-3 bg-gray-50 border rounded-xl">
                        <option value="">Select Course</option>
                    </select>
                </div>

                <input type="password" name="pass" placeholder="Create Password" required class="w-full p-3 bg-gray-50 border rounded-xl mt-3">
                
                <div class="space-y-2 mt-3">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Human Check</label>
                    <div class="flex items-center space-x-3 bg-white/50 p-2 rounded-lg border border-gray-200">
                        <canvas id="captcha-canvas" width="120" height="40" onclick="generateCaptcha()" class="rounded border shadow-sm cursor-pointer"></canvas>
                        <button type="button" onclick="generateCaptcha()" class="text-gray-400 hover:text-green-600 p-2">üîÑ</button>
                        <input type="text" id="captcha-input" placeholder="Code" required class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                </div>

                <button type="submit" class="btn-primary w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition mt-4 shadow-lg">REGISTER ACCOUNT</button>
            </form>
            <div class="mt-6 text-center text-xs">
                <button onclick="toggleAuthScreen('login')" class="text-green-700 font-bold hover:underline">‚Üê Back to Login</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside id="sidebar" class="text-gray-100 w-72 fixed h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col">
            <div class="p-6 flex items-center space-x-3 border-b border-white/10">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" class="h-10 w-10 rounded-full bg-white p-1">
                <div>
                    <h1 class="font-black text-lg leading-tight tracking-tight uppercase">Tula's</h1>
                    <!-- SIDEBAR TAGLINE -->
                    <p class="text-[9px] text-green-400 font-medium uppercase tracking-tight leading-none mt-0.5">Empowering Futures</p>
                    <p id="nav-role-badge" class="text-[10px] text-white/40 uppercase tracking-widest font-black mt-1">Portal</p>
                </div>
            </div>
            <nav id="nav-links" class="flex-1 overflow-y-auto py-6 space-y-1"></nav>
            <div class="p-4 border-t border-white/10">
                <button onclick="logout()" class="w-full flex items-center space-x-3 px-4 py-3 text-red-300 hover:bg-red-500/20 rounded-xl transition">
                    <span>üö™</span><span class="font-bold">Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <div class="flex-1 md:ml-72 flex flex-col min-h-screen bg-gray-50">
            <header class="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-20">
                <div class="flex items-center space-x-3">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv_4ADbeFBqg9mRZQYTRGpzcdXlZN0IFw_0A&s" class="h-8">
                    <span class="font-black text-green-800 tracking-tighter uppercase text-sm">Tula's Connect</span>
                </div>
                <button onclick="toggleSidebar()" class="p-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">‚ò∞</button>
            </header>

            <main class="p-4 md:p-8 flex-1 overflow-y-auto">
                <div id="content-area" class="max-w-6xl mx-auto min-h-[85vh] p-6 md:p-10 bg-white rounded-2xl shadow-xl border border-gray-100 animate-fadeIn">
                    <!-- Dynamic Content Loads Here -->
                </div>
            </main>
        </div>
    </div>

    <!-- AI Helper Button -->
    <button id="chatbot-open-btn" onclick="toggleChatbot()" class="fixed bottom-5 left-5 w-14 h-14 bg-green-600 rounded-full shadow-2xl hover:bg-green-700 transition transform hover:scale-110 z-40 flex items-center justify-center text-2xl">
        ü§ñ
    </button>

    <!-- AI Modal -->
    <div id="chatbot-modal" class="hidden fixed bottom-5 left-5 w-full max-w-sm h-[60vh] bg-white rounded-2xl shadow-2xl flex flex-col z-50 overflow-hidden transform transition-all">
        <div class="p-4 bg-green-800 text-white flex justify-between items-center">
            <h3 class="font-bold">Tula's AI Assistant</h3>
            <button onclick="toggleChatbot()" class="text-2xl">&times;</button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>
        <form id="chat-form" class="p-3 border-t bg-white">
            <div class="flex space-x-2">
                <input type="text" id="chat-input" placeholder="Ask me anything..." class="flex-1 p-2 border rounded-xl outline-none focus:ring-1 focus:ring-green-500">
                <button type="submit" class="bg-green-600 text-white px-4 rounded-xl hover:bg-green-700 transition">Send</button>
            </div>
        </form>
    </div>

<script>
// =========================================
// === CONFIGURATION & DATA ===
// =========================================
const API_BASE = ''; 
let currentUser = JSON.parse(sessionStorage.getItem('user')) || null;
let currentCaptcha = '';
let currentLoginCaptcha = ''; 
const REQUIRED_DOMAIN = '@tulas.edu.in'; 

const DEPT_DATA = {
    "Department of Engineering": {
        branches: ["Computer Science & Engineering", "Civil Engineering", "Mechanical Engineering", "Electronics & Communication Engineering", "Electrical & Electronics Engineering"],
        courses: ["B.Tech CSE", "B.Tech Civil", "B.Tech Mechanical", "B.Tech ECE", "B.Tech EEE", "M.Tech CSE", "M.Tech Civil", "M.Tech Thermal Engg"],
        years: ["1st Year", "2nd Year", "3rd Year", "4th Year"],
        sections: ["A", "B", "C"]
    },
    "Department of Computer Applications": { courses: ["BCA", "MCA"], years: ["1st Year", "2nd Year", "3rd Year"], sections: ["A", "B"] },
    "Graduate School of Business": { courses: ["BBA", "MBA", "B.Com (Hons)"], years: ["1st Year", "2nd Year"], sections: ["A"] },
    "Department of Agriculture": { courses: ["B.Sc Agriculture"], years: ["1st Year", "2nd Year", "3rd Year", "4th Year"], sections: ["A"] },
    "Department of Applied Sciences and Humanities": { courses: ["B.Sc Physics", "B.Sc Chemistry", "B.A. English"], years: ["1st Year", "2nd Year", "3rd Year"], sections: ["A"] },
    "Department of Journalism and Communications": { courses: ["BA (Hons) Journalism & Mass Comm", "MA JMC"], years: ["1st Year", "2nd Year"], sections: ["A"] },
    "Tula's Institute of Pharmacy": { courses: ["B.Pharm", "D.Pharm"], years: ["1st Year", "2nd Year", "3rd Year", "4th Year"], sections: ["A"] }
};

// =========================================
// === INITIALIZATION & LOGIN FLOW ===
// =========================================
document.addEventListener('DOMContentLoaded', () => {
    initAuthDropdowns();
    generateCaptcha(); 
    generateLoginCaptcha(); 

    const authWrapper = document.getElementById('auth-wrapper');
    const dashboard = document.getElementById('dashboard');

    if (currentUser) {
        authWrapper.style.display = 'none';
        dashboard.classList.remove('hidden');
        showDashboard();
    } else {
        authWrapper.style.display = 'flex'; 
        updateAuthUI();
    }

    // Login logic
    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const captcha = document.getElementById('login-captcha-input').value.toUpperCase();
        if (captcha !== currentLoginCaptcha) {
            showToast('Incorrect Captcha', true);
            generateLoginCaptcha();
            return;
        }
        
        const role = document.getElementById('login-role').value;
        let dept = null;
        if (role === 'Department Login') {
            dept = document.getElementById('login-dept').value;
            if (dept === 'Department of Engineering') dept = document.getElementById('login-eng-branch').value;
        }

        await handleAuth('/login', {
            userId: document.getElementById('login-id').value.trim(),
            password: document.getElementById('login-pass').value,
            role: role === 'Department Login' ? 'HOD' : role,
            department: dept,
        });
    };

    // Signup logic
    document.getElementById('signup-form').onsubmit = async (e) => {
        e.preventDefault();
        const captcha = document.getElementById('captcha-input').value.toUpperCase();
        if (captcha !== currentCaptcha) {
            showToast('Incorrect Captcha', true);
            generateCaptcha();
            return;
        }
        const formData = new FormData(e.target);
        const payload = Object.fromEntries(formData);
        if (!payload.email.toLowerCase().endsWith(REQUIRED_DOMAIN)) {
            showToast(`Must use institutional email ${REQUIRED_DOMAIN}`, true);
            return;
        }
        await handleAuth('/signup', payload, true);
    };
});

// =========================================
// === CORE LOGIC FUNCTIONS ===
// =========================================

async function handleAuth(endpoint, payload, isSignup = false) {
    try {
        const res = await fetch(API_BASE + endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            if (isSignup) {
                showToast('Registration submitted for approval.');
                toggleAuthScreen('login');
            } else {
                currentUser = data.user;
                sessionStorage.setItem('user', JSON.stringify(currentUser));
                showDashboard();
            }
        } else {
            showToast(data.message || 'Error', true);
            isSignup ? generateCaptcha() : generateLoginCaptcha();
        }
    } catch (err) {
        showToast('Connection Error', true);
    }
}

function showDashboard() {
    document.getElementById('auth-wrapper').style.display = 'none';
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('nav-role-badge').textContent = currentUser.role.toUpperCase();
    renderNavigation();
}

function renderNavigation() {
    const nav = document.getElementById('nav-links');
    nav.innerHTML = '';
    const MENU = {
        'Student': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'timetable', label: 'Timetable', icon: 'üìÖ' },
            { id: 'attendance', label: 'Attendance', icon: 'üìä' },
            { id: 'assignments', label: 'Assignments', icon: 'üìÅ' },
            { id: 'marks', label: 'Exam Results', icon: 'üìù' },
            { id: 'leaves', label: 'Leave Apply', icon: 'üì®' }
        ],
        'Faculty': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'fac-attendance', label: 'Mark Attendance', icon: '‚úÖ' },
            { id: 'fac-assignments', label: 'Manage Assignments', icon: 'üìö' },
            { id: 'fac-leaves', label: 'Student Leaves', icon: 'üì´' }
        ],
        'HOD': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'admin-batches', label: 'Manage Batches', icon: 'üë•' },
            { id: 'admin-signup-requests', label: 'Sign-up Req', icon: '‚úã' },
            { id: 'fac-leaves', label: 'Approve Leaves', icon: '‚úÖ' }
        ],
        'Admin': [
            { id: 'profile', label: 'My Profile', icon: 'üë§' },
            { id: 'admin-users', label: 'Manage Users', icon: 'üë•' },
            { id: 'admin-announcements', label: 'Announcements', icon: 'üì¢' },
            { id: 'admin-signup-requests', label: 'Approvals', icon: '‚úã' }
        ]
    };
    (MENU[currentUser.role] || []).forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav-link w-full flex items-center space-x-3 transition-all duration-200';
        btn.innerHTML = `<span class="text-xl">${item.icon}</span><span class="font-medium">${item.label}</span>`;
        btn.onclick = () => loadContent(item.id, btn);
        nav.appendChild(btn);
    });
    if (nav.firstChild) nav.firstChild.click();
}

async function loadContent(pageId, activeBtn) {
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    if (activeBtn) activeBtn.classList.add('active');
    
    if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
    const container = document.getElementById('content-area');
    container.innerHTML = '<div class="loader"></div>';

    try {
        switch (pageId) {
            case 'profile': await loadProfile(container); break;
            case 'timetable': await loadTimetable(container); break;
            case 'attendance': await loadAttendance(container); break;
            case 'marks': await loadMarks(container); break;
            case 'assignments': await loadAssignmentsStudent(container); break;
            case 'leaves': await loadLeavesCommon(container); break;
            case 'fac-attendance': loadFacultyAttendance(container); break;
            case 'fac-assignments': await loadFacultyAssignments(container); break;
            case 'fac-leaves': await loadFacultyLeaves(container); break;
            case 'admin-users': await loadAdminUsers(container); break;
            case 'admin-announcements': await loadAdminAnnouncements(container); break;
            case 'admin-signup-requests': await showAdminSignupRequests(container); break;
            case 'admin-batches': await loadAdminBatches(container); break;
            default: container.innerHTML = `<p class="text-center text-gray-400 py-20">Page under construction</p>`;
        }
    } catch (err) {
        container.innerHTML = `<div class="p-6 bg-red-50 text-red-600 rounded-xl">Error loading content. Please try again.</div>`;
    }
}

// RESTORED CORE FUNCTIONS (STUBBED FOR PERFORMANCE)
async function loadProfile(container) {
    const res = await fetch(`${API_BASE}/profile/${currentUser.id}`);
    const data = await res.json();
    if (!data.success) throw new Error("Profile not found");
    const p = data.profile;
    container.innerHTML = `
        <div class="flex flex-col md:flex-row gap-8 items-start">
            <div class="w-full md:w-1/3 bg-gradient-to-br from-green-50 to-white p-8 rounded-2xl border border-green-100 text-center shadow-lg">
                <img src="${p.photoUrl ? API_BASE+p.photoUrl : 'https://placehold.co/150?text='+p.name[0]}" class="w-32 h-32 mx-auto rounded-full object-cover border-4 border-white shadow-md mb-4">
                <h2 class="text-2xl font-bold text-gray-800">${p.name}</h2>
                <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mt-2 uppercase tracking-wide">${p.role}</span>
                <p class="text-gray-500 mt-4 font-mono text-sm">${p.id}</p>
                <button onclick="showUserProfileEditForm('${p.id}')" class="mt-6 w-full bg-yellow-500 text-white px-4 py-2 rounded-xl hover:bg-yellow-600 transition font-bold shadow-md">Edit Profile</button>
            </div>
            <div class="flex-1 bg-gray-50/50 p-8 rounded-2xl w-full border border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="bg-green-600 w-2 h-6 mr-3 rounded-full"></span> Personal Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    ${detailItem('Email', p.email)}
                    ${detailItem('Phone', p.phone || 'N/A')}
                    ${detailItem('Department', p.department)}
                    ${p.course ? detailItem('Course', p.course) : ''}
                    ${detailItem('DOB', p.dob || 'Not set')}
                    ${detailItem('Blood Group', p.bloodGroup || 'Not set')}
                </div>
            </div>
        </div>`;
}

function detailItem(label, value) {
    return `<div><p class="text-xs text-gray-400 uppercase font-black tracking-widest mb-1">${label}</p><p class="font-semibold text-gray-800">${value}</p></div>`;
}

function generateCaptchaText(id) {
    const canvas = document.getElementById(id); if(!canvas) return '';
    const ctx = canvas.getContext('2d');
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let text = '';
    ctx.clearRect(0,0,120,40);
    ctx.font = 'bold 20px monospace';
    for(let i=0; i<5; i++) {
        const c = chars.charAt(Math.floor(Math.random()*chars.length));
        text += c;
        ctx.fillStyle = `rgb(${Math.random()*100},${Math.random()*100},${Math.random()*100})`;
        ctx.save(); ctx.translate(15+(i*20), 25+(Math.random()*5)); ctx.rotate((Math.random()-0.5)*0.3);
        ctx.fillText(c, 0, 0); ctx.restore();
    }
    return text;
}
function generateCaptcha() { currentCaptcha = generateCaptchaText('captcha-canvas'); }
function generateLoginCaptcha() { currentLoginCaptcha = generateCaptchaText('login-captcha-canvas'); }

function initAuthDropdowns() {
    const selects = [document.getElementById('login-dept'), document.getElementById('signup-dept')];
    selects.forEach(s => {
        if(s) s.innerHTML = '<option value="">Select Department</option>' + Object.keys(DEPT_DATA).map(d => `<option value="${d}">${d}</option>`).join('');
    });
}

function updateAuthUI() {
    const role = document.getElementById('login-role').value;
    const isHOD = role === 'Department Login';
    document.getElementById('login-dept-wrapper').classList.toggle('hidden', !isHOD);
    if(isHOD && document.getElementById('login-dept').value === 'Department of Engineering') {
        document.getElementById('login-eng-branch-wrapper').classList.remove('hidden');
        document.getElementById('login-eng-branch').innerHTML = DEPT_DATA['Department of Engineering'].branches.map(b => `<option>${b}</option>`).join('');
    } else {
        document.getElementById('login-eng-branch-wrapper').classList.add('hidden');
    }
}

function updateSignupUI() {
    const role = document.getElementById('signup-role').value;
    const dept = document.getElementById('signup-dept').value;
    document.getElementById('signup-dept-wrapper').classList.toggle('hidden', !role);
    document.getElementById('student-fields').classList.toggle('hidden', role !== 'Student');
    if (role === 'Student' && dept) {
        document.getElementById('signup-course-wrapper').classList.remove('hidden');
        document.getElementById('signup-course').innerHTML = (DEPT_DATA[dept]?.courses || []).map(c => `<option>${c}</option>`).join('');
    } else {
        document.getElementById('signup-course-wrapper').classList.add('hidden');
    }
}

function toggleAuthScreen(s) { 
    document.getElementById('login-box').classList.toggle('hidden', s!=='login');
    document.getElementById('signup-box').classList.toggle('hidden', s!=='signup');
}
function showToast(m, e=false) {
    const t = document.getElementById('toast');
    t.textContent = m;
    t.className = `fixed bottom-5 right-5 transform translate-y-0 opacity-100 transition-all z-50 px-6 py-3 rounded-xl shadow-2xl text-white ${e?'bg-red-600':'bg-green-600'}`;
    setTimeout(() => t.classList.add('translate-y-full', 'opacity-0'), 3000);
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
function toggleChatbot() { document.getElementById('chatbot-modal').classList.toggle('hidden'); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }
function togglePass(id) { const i = document.getElementById(id); i.type = i.type === 'password' ? 'text' : 'password'; }
function logout() { sessionStorage.clear(); location.reload(); }
function addMessageToChat(text, isUser) {
    const history = document.getElementById('chat-history');
    const msg = document.createElement('div');
    msg.className = isUser ? 'flex justify-end' : 'flex justify-start';
    msg.innerHTML = `<div class="${isUser?'bg-green-600 text-white rounded-br-none':'bg-gray-200 text-gray-800 rounded-bl-none'} p-3 rounded-2xl max-w-[80%] text-sm font-medium shadow-sm">${text}</div>`;
    history.appendChild(msg);
    history.scrollTop = history.scrollHeight;
}
</script>
</body>
</html>